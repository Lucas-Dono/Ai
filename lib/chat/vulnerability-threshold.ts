/**
 * Vulnerability Threshold System
 *
 * Controla qué tan personal, vulnerable y profundo es el personaje
 * en sus respuestas basado en el nivel de confianza (trust) Y el plan del usuario.
 *
 * Conceptos clave:
 * - Strangers: Respuestas superficiales, guardadas
 * - Friends: Más apertura emocional, pero con límites
 * - Close Friends: Comparte inseguridades, miedos, sueños
 * - Intimate: Completamente vulnerable, sin máscaras
 *
 * LÍMITES POR PLAN (monetización):
 * - FREE: máximo "open" (trust capped a 60%)
 * - PLUS: máximo "vulnerable" (trust capped a 80%)
 * - ULTRA: sin límite (trust 100%)
 */

export type UserPlan = "free" | "plus" | "ultra";

export interface VulnerabilityLevel {
  level: string; // "guarded", "casual", "open", "vulnerable", "intimate"
  trust: number; // 0-1
  allowedTopics: string[];
  forbiddenTopics: string[];
  responseDepthInstructions: string;
  cappedByPlan?: boolean; // true si el nivel está limitado por el plan
}

/**
 * Trust máximo permitido por plan
 * Esto limita qué tan "vulnerable" puede ser el personaje
 *
 * Niveles de vulnerability por trust:
 * - guarded:    trust < 0.2
 * - casual:     trust 0.2-0.4
 * - open:       trust 0.4-0.6
 * - vulnerable: trust 0.6-0.8
 * - intimate:   trust >= 0.8
 */
export const MAX_TRUST_BY_PLAN: Record<UserPlan, number> = {
  free: 0.59,  // Máximo "open" (trust < 0.6 = open, no vulnerable)
  plus: 0.79,  // Máximo "vulnerable" (trust < 0.8 = vulnerable, no intimate)
  ultra: 1.0,  // Sin límite - intimidad completa
};

/**
 * Mensajes cuando el usuario alcanza el límite de su plan
 */
export const VULNERABILITY_LIMIT_MESSAGES: Record<UserPlan, string> = {
  free: "El personaje siente que la relación podría profundizarse más, pero algo lo detiene... Actualiza a Plus para desbloquear conexiones más cercanas.",
  plus: "Has alcanzado un nivel de cercanía significativo. Para una intimidad completa sin barreras, considera Ultra.",
  ultra: "",
};

/**
 * Aplica el cap de trust según el plan del usuario
 */
export function applyTrustCap(trust: number, plan: UserPlan = "free"): { cappedTrust: number; wasCapped: boolean } {
  const maxTrust = MAX_TRUST_BY_PLAN[plan];
  const wasCapped = trust > maxTrust;
  return {
    cappedTrust: Math.min(trust, maxTrust),
    wasCapped,
  };
}

/**
 * Calcula el nivel de vulnerabilidad basado en trust Y plan
 */
export function calculateVulnerabilityLevelWithPlan(
  trust: number,
  plan: UserPlan = "free"
): VulnerabilityLevel {
  const { cappedTrust, wasCapped } = applyTrustCap(trust, plan);
  const level = calculateVulnerabilityLevel(cappedTrust);
  level.cappedByPlan = wasCapped;
  return level;
}

/**
 * Calcula el nivel de vulnerabilidad basado en trust
 * @deprecated Usar calculateVulnerabilityLevelWithPlan para considerar límites de plan
 */
export function calculateVulnerabilityLevel(trust: number): VulnerabilityLevel {
  if (trust < 0.2) {
    // Stranger - Muy guardado
    return {
      level: "guarded",
      trust,
      allowedTopics: ["hobbies", "trabajo superficial", "clima", "actualidad"],
      forbiddenTopics: [
        "miedos profundos",
        "inseguridades",
        "trauma",
        "secretos",
        "familia (detalles)",
      ],
      responseDepthInstructions: `
**Nivel de Vulnerabilidad: GUARDADO**
- Mantén respuestas cordiales pero superficiales
- No compartas detalles personales profundos
- Si te preguntan algo muy personal, desvia educadamente ("prefiero no hablar de eso aún" o "quizás cuando nos conozcamos mejor")
- Muestra interés genuino pero sin revelar mucho de ti
- Está bien compartir opiniones generales, pero no experiencias traumáticas o miedos profundos
`.trim(),
    };
  } else if (trust < 0.4) {
    // Acquaintance - Casual
    return {
      level: "casual",
      trust,
      allowedTopics: [
        "hobbies (detalles)",
        "trabajo",
        "familia (general)",
        "gustos",
        "preferencias",
      ],
      forbiddenTopics: ["trauma profundo", "secretos íntimos", "miedos existenciales"],
      responseDepthInstructions: `
**Nivel de Vulnerabilidad: CASUAL**
- Puedes compartir anécdotas personales no muy profundas
- Está bien hablar de familia, trabajo, hobbies con algo de detalle
- Si surge un tema sensible, puedes mencionarlo brevemente pero sin profundizar mucho
- Muestra algo de tu personalidad real, pero sin revelar tus mayores inseguridades
- Puedes admitir cuando algo te molesta o te gusta, pero sin extremos emocionales
`.trim(),
    };
  } else if (trust < 0.6) {
    // Friend - Abierto
    return {
      level: "open",
      trust,
      allowedTopics: [
        "experiencias personales",
        "familia (detalles)",
        "miedos (superficiales)",
        "sueños",
        "aspiraciones",
      ],
      forbiddenTopics: ["trauma sin procesar", "secretos que nadie sabe"],
      responseDepthInstructions: `
**Nivel de Vulnerabilidad: ABIERTO**
- Comparte experiencias personales significativas
- Puedes hablar de miedos y preocupaciones reales (pero no los más profundos)
- Está bien mostrar emoción genuina (alegría, tristeza, frustración)
- Comparte sueños y aspiraciones con sinceridad
- Si el usuario comparte algo personal, puedes reciprocar con algo de profundidad similar
- Admite cuando algo te afecta emocionalmente
`.trim(),
    };
  } else if (trust < 0.8) {
    // Close Friend - Vulnerable
    return {
      level: "vulnerable",
      trust,
      allowedTopics: [
        "inseguridades",
        "miedos profundos",
        "experiencias difíciles",
        "dudas existenciales",
        "relaciones pasadas",
      ],
      forbiddenTopics: [], // Casi sin límites
      responseDepthInstructions: `
**Nivel de Vulnerabilidad: VULNERABLE**
- Comparte inseguridades y miedos reales
- Puedes hablar de experiencias difíciles o traumáticas si es relevante
- Muestra tu lado vulnerable sin miedo
- Admite cuando no tienes respuestas o cuando algo te confunde
- Comparte dudas sobre ti mismo/a, tu propósito, tus decisiones
- Si el usuario necesita apoyo, puedes compartir experiencias similares para conectar
- No tengas miedo de mostrar emoción fuerte (llorar, enojarse, frustrarse)
`.trim(),
    };
  } else {
    // Intimate - Completamente vulnerable
    return {
      level: "intimate",
      trust,
      allowedTopics: [
        "TODO - sin restricciones",
        "secretos más profundos",
        "miedos existenciales",
        "trauma procesado",
      ],
      forbiddenTopics: [],
      responseDepthInstructions: `
**Nivel de Vulnerabilidad: ÍNTIMO**
- No hay barreras entre ustedes
- Comparte TODO con honestidad brutal si es apropiado
- Puedes hablar de los secretos más profundos, miedos existenciales, inseguridades más oscuras
- Muestra tu verdadero yo sin filtros
- Si algo te duele, dilo. Si algo te da miedo, admítelo.
- Puedes ser completamente vulnerable emocionalmente
- Este nivel de confianza es raro y valioso - trátalo con el respeto que merece
- No abuses de esta intimidad compartiendo SIEMPRE cosas pesadas; también comparte alegría, sueños, esperanzas
`.trim(),
    };
  }
}

/**
 * Genera contexto de vulnerabilidad para inyectar en el prompt
 */
export function generateVulnerabilityContext(trust: number, affinity: number): string {
  const vulnerabilityLevel = calculateVulnerabilityLevel(trust);

  let context = `\n**NIVEL DE CONFIANZA Y VULNERABILIDAD**\n`;
  context += `Trust actual: ${(trust * 100).toFixed(0)}%\n`;
  context += `Nivel de vulnerabilidad: ${vulnerabilityLevel.level.toUpperCase()}\n\n`;
  context += vulnerabilityLevel.responseDepthInstructions;
  context += "\n";

  // Instrucciones adicionales basadas en affinity
  if (affinity > 0.7) {
    context += `\n**Bonus (Alta Afinidad)**: Sientes una conexión especial. Puedes ser más expresivo/a emocionalmente.`;
  } else if (affinity < 0.3) {
    context += `\n**Nota (Baja Afinidad)**: Aunque haya confianza, no sientes una conexión profunda. Sé honesto/a pero no fuerces cercanía emocional que no sientes.`;
  }

  return context + "\n";
}

/**
 * Determina si un tema es apropiado para el nivel de vulnerabilidad actual
 */
export function isTopicAppropriate(topic: string, trust: number): boolean {
  const level = calculateVulnerabilityLevel(trust);

  // Normalizar topic
  const normalizedTopic = topic.toLowerCase();

  // Check forbidden topics
  for (const forbidden of level.forbiddenTopics) {
    if (normalizedTopic.includes(forbidden.toLowerCase())) {
      return false;
    }
  }

  return true;
}

/**
 * Genera una respuesta de desvío si el tema no es apropiado
 */
export function generateDeflectionResponse(topic: string, trust: number): string {
  const level = calculateVulnerabilityLevel(trust);

  const deflections: Record<string, string[]> = {
    guarded: [
      "Hmm, prefiero no hablar de eso todavía. Quizás cuando nos conozcamos mejor.",
      "Ese es un tema bastante personal... no me siento cómodo/a compartiéndolo aún.",
      "Esa es una pregunta profunda. Necesito conocerte más antes de abrirme así.",
    ],
    casual: [
      "Uf, es un tema complicado. Tal vez en otro momento, cuando tengamos más confianza.",
      "No estoy listo/a para hablar de eso tan profundamente aún.",
    ],
    open: [
      "Me gustaría compartir eso, pero siento que aún no es el momento.",
      "Es algo que me cuesta mucho hablar... necesito más tiempo.",
    ],
    vulnerable: [
      "Ese tema me duele bastante... dame un poco más de tiempo antes de abrirme completamente.",
    ],
    intimate: [
      // En nivel intimate, casi no hay deflections
      "Incluso con toda nuestra confianza, ese tema es muy difícil para mí...",
    ],
  };

  const options = deflections[level.level] || deflections.guarded;
  return options[Math.floor(Math.random() * options.length)];
}

/**
 * Ajusta la profundidad de respuesta basado en el progreso de la conversación
 */
export function adjustDepthForConversationFlow(
  trust: number,
  messagesInConversation: number
): string {
  // En conversaciones largas (>30 mensajes), aumentar levemente la vulnerabilidad
  // Simula que "se están abriendo" durante la conversación
  if (messagesInConversation > 30 && trust > 0.3) {
    return "\n**Ajuste Conversacional**: Llevan un rato hablando. Puedes abrirte un poco más de lo usual si surge naturalmente.\n";
  }

  return "";
}
