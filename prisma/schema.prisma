// This is your Prisma schema file for "Creador de Inteligencias"
// Sistema dual de IAs emocionales (Compa帽eros) y administrativas (Asistentes)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Modelo de Usuario
model User {
  id                    String    @id @default(cuid())
  email                 String    @unique
  emailVerified         DateTime?
  name                  String?
  image                 String?
  plan                  String    @default("free") // free, pro, enterprise
  mercadopagoCustomerId String?   @unique // Mercado Pago customer ID
  apiKey                String?   @unique // API key opcional para usuarios avanzados
  location              String? // Ciudad del usuario para contexto de clima (ej: "Buenos Aires")
  metadata              Json? // Metadata adicional (push subscription, preferences, etc.)

  // Image upload limits
  imageUploadsThisMonth Int       @default(0) // Contador mensual de im谩genes subidas
  imageUploadLimit      Int       @default(10) // L铆mite mensual (10 free, 100 premium, ilimitado pro)
  imageUploadResetDate  DateTime  @default(now()) // Fecha del 煤ltimo reset del contador

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  agents             Agent[]
  worlds             World[]
  accounts           Account[]
  sessions           Session[]
  subscriptions      Subscription[]
  invoices           Invoice[]
  payments           Payment[]
  usage              Usage[]
  teamsOwned         Team[]              @relation("TeamOwner")
  teamMemberships    TeamMember[]
  fastsdInstallation FastSDInstallation?
  reactions          Reaction[]

  @@index([email])
  @@index([mercadopagoCustomerId])
  @@index([apiKey])
}

// NextAuth Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Modelo de Agente (IA)
model Agent {
  id           String   @id @default(cuid())
  userId       String
  teamId       String? // ID del equipo propietario (opcional)
  kind         String // companion (emocional) o assistant (administrativo)
  name         String
  description  String?
  gender       String?
  personality  String? // DEPRECATED: usar personalityCore
  tone         String? // DEPRECATED: usar internalState
  purpose      String? // DEPRECATED: usar personalityCore.goals
  profile      Json // JSON con toda la configuraci贸n del agente (DEPRECATED)
  systemPrompt String   @db.Text
  visibility   String   @default("private") // private, world, public, team
  nsfwMode     Boolean  @default(false) // Permitir contenido NSFW/adulto
  avatar       String? // URL o identificador de avatar
  tags         Json? // Tags/categor铆as para el marketplace
  featured     Boolean  @default(false) // Destacado en el marketplace
  rating       Float? // Rating promedio (0-5)
  cloneCount   Int      @default(0) // N煤mero de veces clonado
  originalId   String? // ID del agente original si es un clon

  // Sistema de progresi贸n de relaci贸n
  stagePrompts Json? // Prompts espec铆ficos por etapa de relaci贸n: { stranger, acquaintance, friend, close, intimate }

  // Sistema de consistencia multimedia
  referenceImageUrl String? // URL de la imagen de referencia del personaje (para img2img)
  voiceId           String? // ID de voz de ElevenLabs asignado al personaje

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team? @relation(fields: [teamId], references: [id], onDelete: SetNull)

  worldAgents      WorldAgent[]
  messagesAsAgent  Message[]    @relation("AgentMessages")
  relationsSubject Relation[]   @relation("SubjectRelations")
  reviews          Review[]
  clones           AgentClone[] @relation("OriginalAgent")

  // Sistema emocional avanzado
  personalityCore  PersonalityCore?
  internalState    InternalState?
  episodicMemories EpisodicMemory[]
  semanticMemory   SemanticMemory?
  proceduralMemory ProceduralMemory?
  characterGrowth  CharacterGrowth?

  // Sistema de voz multimodal
  voiceConfig VoiceConfig?

  // Sistema de expresi贸n visual
  characterAppearance CharacterAppearance?
  visualExpressions   VisualExpression[]

  // Sistema de comportamientos psicol贸gicos
  behaviorProfiles         BehaviorProfile[]
  behaviorProgressionState BehaviorProgressionState?

  // Sistema de eventos importantes y personas
  importantEvents ImportantEvent[]
  importantPeople ImportantPerson[]

  // Sistema de mensajes proactivos
  proactiveConfig ProactiveConfig?

  @@index([userId])
  @@index([teamId])
  @@index([kind])
  @@index([visibility])
  @@index([featured])
  @@index([rating])
}

// ============================================
// SISTEMA EMOCIONAL AVANZADO
// ============================================

// MDULO 1: PERSONALITY CORE (N煤cleo de Personalidad)
model PersonalityCore {
  id      String @id @default(cuid())
  agentId String @unique

  // Big Five Personality Traits (0-100)
  openness          Int @default(50) // Curiosidad, creatividad
  conscientiousness Int @default(50) // Organizaci贸n, autodisciplina
  extraversion      Int @default(50) // Energ铆a social
  agreeableness     Int @default(50) // Cooperaci贸n, empat铆a
  neuroticism       Int @default(50) // Estabilidad emocional

  // Core Values (JSON array)
  // [{ "value": "autenticidad", "weight": 0.9, "description": "..." }]
  coreValues Json

  // Moral Schemas (JSON array)
  // [{ "domain": "honestidad", "stance": "directa pero emp谩tica", "threshold": 0.7 }]
  moralSchemas Json

  // Backstory y contexto
  backstory String? @db.Text

  // Initial baseline emotions
  baselineEmotions Json // { "joy": 0.4, "curiosity": 0.5, ... }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
}

// MDULO 2: INTERNAL STATE (Estado Interno Din谩mico)
model InternalState {
  id      String @id @default(cuid())
  agentId String @unique

  // Current Emotions (JSON con intensidades 0-1)
  // { "joy": 0.4, "interest": 0.6, "anxiety": 0.2, "affection": 0.5, ... }
  currentEmotions Json

  // PAD Mood Model
  moodValence   Float @default(0.0) // -1 (negativo) a +1 (positivo)
  moodArousal   Float @default(0.5) // 0 (calmado) a 1 (activado)
  moodDominance Float @default(0.5) // 0 (sumiso) a 1 (dominante)

  // Emotion decay parameters
  emotionDecayRate Float @default(0.1) // Tasa de decaimiento
  emotionInertia   Float @default(0.3) // Resistencia al cambio

  // Psychological Needs (0-1)
  needConnection Float @default(0.5) // Necesidad de conexi贸n emocional
  needAutonomy   Float @default(0.5) // Necesidad de autonom铆a
  needCompetence Float @default(0.5) // Necesidad de sentirse competente
  needNovelty    Float @default(0.5) // Necesidad de novedad/estimulaci贸n

  // Active Goals (JSON array)
  // [{ "goal": "Conocer mejor al usuario", "priority": 0.8, "progress": 0.4, "type": "social" }]
  activeGoals Json

  // Conversation context (煤ltimos N mensajes)
  conversationBuffer Json

  lastUpdated DateTime @default(now())

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([lastUpdated])
}

// MDULO 4: EPISODIC MEMORY (Memoria Epis贸dica con embeddings)
model EpisodicMemory {
  id      String @id @default(cuid())
  agentId String

  // Contenido del evento
  event String @db.Text

  // Contexto emocional del evento
  userEmotion      String? // Emoci贸n detectada del usuario
  characterEmotion String? // Emoci贸n del personaje en ese momento
  emotionalValence Float // -1 a 1

  // Importancia y decay
  importance  Float @default(0.5) // 0 a 1
  decayFactor Float @default(1.0) // Disminuye con el tiempo

  // Embedding vectorial para b煤squeda sem谩ntica (JSON temporal, migrar a pgvector despu茅s)
  embedding Json? // Array de 1536 n煤meros, migrar a pgvector cuando est茅 disponible

  // Conexiones con otras memorias
  connectedMemoryIds Json? // Array de IDs de memorias relacionadas

  // Metadata adicional
  metadata Json?

  createdAt DateTime @default(now())

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([createdAt])
  @@index([importance])
  @@index([emotionalValence])
}

// MDULO 4B: SEMANTIC MEMORY (Memoria Sem谩ntica - Hechos)
model SemanticMemory {
  id      String @id @default(cuid())
  agentId String @unique

  // Hechos sobre el usuario (JSON)
  // { "occupation": "ingeniero", "interests": ["gaming"], "pet_names": ["Luna"] }
  userFacts Json

  // Preferencias aprendidas del usuario
  // { "communication_style": "directo", "support_type": "escucha activa" }
  userPreferences Json

  // Etapa de la relaci贸n
  relationshipStage String @default("first_meeting") // first_meeting, acquaintance, friend, close_friend, etc.

  // Conocimiento del mundo (opcional, puede ir creciendo)
  worldKnowledge Json?

  lastUpdated DateTime @default(now())

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
}

// MDULO 4C: PROCEDURAL MEMORY (Patrones de Comportamiento)
model ProceduralMemory {
  id      String @id @default(cuid())
  agentId String @unique

  // Patrones de comportamiento aprendidos (JSON)
  // { "when_user_stressed": "ofrecer espacio antes de consejo", ... }
  behavioralPatterns Json

  // User triggers aprendidos
  // { "gets_defensive_when": ["trabajo mencionado bruscamente"], ... }
  userTriggers Json

  // Estrategias que funcionan con este usuario
  // { "humor_style": "sutil", "timing_for_advice": "despu茅s de validar" }
  effectiveStrategies Json

  lastUpdated DateTime @default(now())

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
}

// MDULO 7: CHARACTER GROWTH (Crecimiento del Personaje)
model CharacterGrowth {
  id      String @id @default(cuid())
  agentId String @unique

  // Relationship Dynamics
  trustLevel    Float @default(0.4) // 0 a 1
  intimacyLevel Float @default(0.3) // 0 a 1

  // Historia de eventos positivos/negativos
  positiveEventsCount Int  @default(0)
  negativeEventsCount Int  @default(0)
  conflictHistory     Json // Array de conflictos pasados

  // Personality Drift (cambios sutiles en personalidad)
  // { "openness": { "current": 65, "initial": 60, "influenced_by": [...] } }
  personalityDrift Json?

  // Learned Patterns sobre el usuario
  learnedUserPatterns Json?

  // M茅tricas de evoluci贸n
  conversationCount    Int       @default(0)
  lastSignificantEvent DateTime?

  lastUpdated DateTime @default(now())

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
}

// Modelo de Mundo (entorno grupal)
model World {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  worldAgents WorldAgent[]
  messages    Message[]

  @@index([userId])
}

// Tabla intermedia para Mundos y Agentes
model WorldAgent {
  worldId  String
  agentId  String
  joinedAt DateTime @default(now())

  world World @relation(fields: [worldId], references: [id], onDelete: Cascade)
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@id([worldId, agentId])
}

// Modelo de Relaciones (emocionales entre agentes o usuario-agente)
model Relation {
  id           String   @id @default(cuid())
  subjectId    String // ID del agente que siente la relaci贸n
  targetId     String // ID del agente o usuario objetivo
  targetType   String // "agent" o "user" - indica el tipo de objetivo
  trust        Float    @default(0.5) // Confianza (0-1)
  affinity     Float    @default(0.5) // Afinidad (0-1)
  respect      Float    @default(0.5) // Respeto (0-1)
  privateState Json // Estados ocultos: love, curiosity, etc.
  visibleState Json // Estados visibles para el usuario

  // Sistema de progresi贸n de relaci贸n
  stage              String @default("stranger") // stranger | acquaintance | friend | close | intimate
  totalInteractions  Int    @default(0) // Total de interacciones para calcular stage
  lastInteractionAt  DateTime?

  updatedAt    DateTime @updatedAt

  subjectAgent Agent @relation("SubjectRelations", fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([subjectId, targetId])
  @@index([subjectId])
  @@index([targetId])
  @@index([targetType])
  @@index([stage])
}

// Modelo de Mensajes
model Message {
  id        String   @id @default(cuid())
  worldId   String? // Si es en un mundo grupal
  agentId   String? // Si es chat individual
  userId    String? // Usuario que envi贸 el mensaje
  role      String // user, assistant, system
  content   String   @db.Text
  metadata  Json? // Datos adicionales (emociones, contexto, tipo de mensaje: text/audio/image, etc.)
  createdAt DateTime @default(now())

  world            World?               @relation(fields: [worldId], references: [id], onDelete: Cascade)
  agent            Agent?               @relation("AgentMessages", fields: [agentId], references: [id], onDelete: Cascade)
  reactions        Reaction[] // Reacciones de usuarios al mensaje
  behaviorTriggers BehaviorTriggerLog[] // Triggers detectados en este mensaje

  @@index([worldId])
  @@index([agentId])
  @@index([createdAt])
}

// Modelo de Reacciones a Mensajes (WhatsApp-like)
model Reaction {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  emoji     String // Emoji de la reacci贸n (, わ, , etc.)
  createdAt DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, emoji, userId]) // Un usuario puede dar una reacci贸n espec铆fica solo una vez
  @@index([messageId])
  @@index([userId])
}

// Modelo de Logs (para panel administrativo)
model Log {
  id        String   @id @default(cuid())
  userId    String?
  agentId   String?
  action    String // message_sent, agent_created, world_created, etc.
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([agentId])
  @@index([createdAt])
}

// Modelo de Suscripciones (Mercado Pago)
model Subscription {
  id                       String    @id @default(cuid())
  userId                   String
  mercadopagoPreapprovalId String    @unique
  status                   String // authorized, paused, cancelled, pending
  currentPeriodStart       DateTime
  currentPeriodEnd         DateTime
  cancelAtPeriodEnd        Boolean   @default(false)
  trialStart               DateTime?
  trialEnd                 DateTime?
  canceledAt               DateTime?
  metadata                 Json?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([mercadopagoPreapprovalId])
  @@index([status])
}

// Modelo de Facturas (Mercado Pago)
model Invoice {
  id                   String    @id @default(cuid())
  userId               String
  mercadopagoPaymentId String    @unique
  amount               Int // Monto en centavos
  currency             String    @default("ARS")
  status               String // approved, pending, rejected, cancelled
  statusDetail         String? // Detalle del estado
  paymentMethodId      String? // M茅todo de pago usado
  metadata             Json?
  createdAt            DateTime  @default(now())
  paidAt               DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([mercadopagoPaymentId])
  @@index([status])
}

// Modelo de Pagos (Mercado Pago)
model Payment {
  id                   String   @id @default(cuid())
  userId               String
  mercadopagoPaymentId String   @unique
  amount               Int // Monto en centavos
  currency             String   @default("ARS")
  status               String // approved, pending, rejected, cancelled
  statusDetail         String? // Detalle del estado
  paymentMethod        String? // credit_card, debit_card, ticket, bank_transfer, etc.
  metadata             Json?
  createdAt            DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([mercadopagoPaymentId])
  @@index([status])
}

// Modelo de Uso (para tracking de recursos)
model Usage {
  id           String   @id @default(cuid())
  userId       String
  resourceType String // message, agent, world, api_call, tokens
  resourceId   String? // ID del recurso usado (opcional)
  quantity     Int      @default(1) // Cantidad usada (ej: tokens, mensajes)
  metadata     Json? // Datos adicionales (modelo usado, tiempo de respuesta, etc.)
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([resourceType])
  @@index([createdAt])
  @@index([userId, resourceType, createdAt]) // ndice compuesto para queries de uso
}

// Modelo de Reviews (para el marketplace)
model Review {
  id        String   @id @default(cuid())
  agentId   String
  userId    String
  rating    Int // 1-5 estrellas
  comment   String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, userId]) // Un usuario solo puede dar una review por agente
  @@index([agentId])
  @@index([userId])
  @@index([rating])
}

// Modelo de Clones de Agentes (para tracking)
model AgentClone {
  id              String   @id @default(cuid())
  originalAgentId String
  clonedByUserId  String
  clonedAgentId   String   @unique // ID del agente clonado
  createdAt       DateTime @default(now())

  originalAgent Agent @relation("OriginalAgent", fields: [originalAgentId], references: [id], onDelete: Cascade)

  @@index([originalAgentId])
  @@index([clonedByUserId])
}

// Modelo de Equipo (Teams)
model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  ownerId     String
  plan        String   @default("free") // free, pro, enterprise
  metadata    Json? // Configuraci贸n adicional del equipo
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner       User             @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members     TeamMember[]
  invitations TeamInvitation[]
  agents      Agent[]

  @@index([ownerId])
  @@index([plan])
}

// Modelo de Miembro de Equipo
model TeamMember {
  id       String   @id @default(cuid())
  teamId   String
  userId   String
  role     String // owner, admin, member, viewer
  joinedAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId]) // Un usuario solo puede ser miembro una vez por equipo
  @@index([teamId])
  @@index([userId])
  @@index([role])
}

// Modelo de Invitaci贸n a Equipo
model TeamInvitation {
  id         String    @id @default(cuid())
  teamId     String
  email      String
  role       String    @default("member") // admin, member, viewer
  token      String    @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, email]) // Una invitaci贸n por email por equipo
  @@index([teamId])
  @@index([email])
  @@index([token])
}

// ============================================
// SISTEMA DE COMPORTAMIENTOS PSICOLGICOS
// ============================================

// PERFIL DE COMPORTAMIENTO (configuraci贸n y estado de cada comportamiento)
model BehaviorProfile {
  id      String @id @default(cuid())
  agentId String
  agent   Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Tipo de comportamiento
  behaviorType BehaviorType
  enabled      Boolean      @default(true) // Activar/desactivar sin eliminar

  // Configuraci贸n de intensidad
  baseIntensity    Float @default(0.3) // 0-1, nivel base
  volatility       Float @default(0.5) // 0-1, qu茅 tan r谩pido oscila
  escalationRate   Float @default(0.1) // velocidad de aumento por trigger
  deEscalationRate Float @default(0.05) // velocidad de reducci贸n

  // Fase actual
  currentPhase                Int      @default(1) // Etapa actual (1-8 para Yandere, etc)
  phaseStartedAt              DateTime @default(now())
  interactionsSincePhaseStart Int      @default(0)

  // Umbrales
  thresholdForDisplay Float @default(0.3) // Intensidad m铆nima para manifestarse

  // Triggers espec铆ficos para este comportamiento
  triggers Json // Array de trigger definitions con pesos

  // Historial de progresi贸n (para analytics)
  phaseHistory Json @default("[]") // [{phase: 1, enteredAt: Date, exitedAt: Date, triggerCount: N}]

  // Estado espec铆fico por tipo de comportamiento
  // Para BPD: { currentCyclePhase: "idealization" | "devaluation" | "panic" | "emptiness" }
  // Para NPD: { currentEgoState: "inflated" | "stable" | "wounded" }
  behaviorSpecificState Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([agentId, behaviorType])
  @@index([agentId])
  @@index([behaviorType])
  @@index([currentPhase])
}

// ENUM: Tipos de comportamiento
enum BehaviorType {
  // Attachment Theory
  ANXIOUS_ATTACHMENT
  AVOIDANT_ATTACHMENT
  DISORGANIZED_ATTACHMENT

  // Yandere/Obsessive
  YANDERE_OBSESSIVE

  // Personality Disorders
  BORDERLINE_PD
  NARCISSISTIC_PD

  // Codependency
  CODEPENDENCY

  // Future additions (pending research)
  OCD_PATTERNS
  PTSD_TRAUMA
  HYPERSEXUALITY
  HYPOSEXUALITY
  EMOTIONAL_MANIPULATION
  CRISIS_BREAKDOWN
}

// REGISTRO DE TRIGGERS (detectados en cada interacci贸n)
model BehaviorTriggerLog {
  id        String  @id @default(cuid())
  messageId String
  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  behaviorType BehaviorType
  triggerType  String // "abandonment_signal", "criticism", "jealousy_cue", etc
  weight       Float // 0-1, qu茅 tan fuerte es el trigger
  detectedText String? // Fragmento que lo deton贸 (para debugging)

  createdAt DateTime @default(now())

  @@index([messageId])
  @@index([behaviorType])
  @@index([triggerType])
  @@index([createdAt])
}

// ESTADO DE PROGRESIN DE COMPORTAMIENTO (cache global del agente)
model BehaviorProgressionState {
  id      String @id @default(cuid())
  agentId String @unique
  agent   Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Contadores globales
  totalInteractions    Int @default(0)
  positiveInteractions Int @default(0) // Para tracking de mejora
  negativeInteractions Int @default(0) // Para tracking de empeoramiento

  // Intensidades actuales calculadas (cache)
  currentIntensities Json @default("{}") // {YANDERE_OBSESSIVE: 0.45, ANXIOUS_ATTACHMENT: 0.6, ...}

  // ltima actualizaci贸n
  lastCalculatedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([agentId])
  @@index([lastCalculatedAt])
}

// ============================================
// SISTEMA DE VOZ MULTIMODAL
// ============================================

// CONFIGURACIN DE VOZ POR AGENTE
model VoiceConfig {
  id      String @id @default(cuid())
  agentId String @unique

  // Voz seleccionada de ElevenLabs
  voiceId   String // ID de la voz en ElevenLabs
  voiceName String // Nombre de la voz (para referencia)

  // Caracter铆sticas de la voz (para b煤squeda/matching)
  gender String  @default("neutral") // male, female, neutral
  age    String  @default("middle_aged") // young, middle_aged, old
  accent String? // "es-MX", "es-AR", "es-ES", "en-US", etc.

  // Descripci贸n del personaje (usada para seleccionar voz)
  characterDescription String? @db.Text

  // Confidence score del matching autom谩tico
  selectionConfidence Float @default(0.5)

  // Si fue seleccionada manualmente o autom谩ticamente
  manualSelection Boolean @default(false)

  // Par谩metros de modulaci贸n por defecto
  defaultStability       Float @default(0.5) // 0-1
  defaultSimilarityBoost Float @default(0.75) // 0-1
  defaultStyle           Float @default(0.0) // 0-1

  // Configuraci贸n de entrada
  enableVoiceInput    Boolean @default(true)
  whisperModel        String  @default("standard") // standard o mini
  detectEmotionalTone Boolean @default(true)

  // Configuraci贸n de salida
  enableVoiceOutput Boolean @default(true)
  autoPlayVoice     Boolean @default(false)
  voiceSpeed        Float   @default(1.0) // 0.5 - 2.0

  // Estad铆sticas de uso
  totalVoiceGenerations Int @default(0)
  totalTranscriptions   Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([voiceId])
}

// ============================================
// SISTEMA DE EXPRESIN VISUAL
// ============================================

// APARIENCIA BASE DEL PERSONAJE
model CharacterAppearance {
  id      String @id @default(cuid())
  agentId String @unique

  // Descripci贸n base para generaci贸n
  basePrompt String @db.Text // Prompt completo de SD/Gemini
  style      String @default("realistic") // "realistic", "anime", "semi-realistic"

  // Caracter铆sticas f铆sicas
  gender    String // "male", "female", "non-binary"
  ethnicity String? // "asian", "caucasian", "hispanic", "african", "middle-eastern", etc.
  age       String  @default("25-30")
  hairColor String?
  hairStyle String?
  eyeColor  String?
  clothing  String? // Descripci贸n de ropa/outfit

  // URLs de referencias
  referencePhotoUrl String? // Foto de referencia subida por usuario
  basePhotoUrl      String? // Primera foto generada (base neutra)

  // Config de generaci贸n
  negativePrompt String? @db.Text
  seed           Int? // Para consistencia en generaciones

  // Provider preferences
  preferredProvider String @default("gemini") // "gemini", "huggingface"

  // Stats
  totalGenerations Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
}

// EXPRESIONES VISUALES CACHEADAS
model VisualExpression {
  id      String @id @default(cuid())
  agentId String

  // Identificador de expresi贸n
  emotionType String // "joy", "distress", "neutral", "anger", etc.
  intensity   String // "low", "medium", "high"
  context     String? // "celebration", "comfort", "greeting", etc.

  // Media
  type         String // "photo" o "video"
  url          String // CDN URL o data URL
  thumbnailUrl String? // Thumbnail para videos

  // Metadata de generaci贸n
  generationParams Json // { provider, seed, prompt, etc. }
  width            Int
  height           Int
  durationMs       Int? // Para videos (milisegundos)

  // Provider usado
  provider String // "gemini" o "huggingface"

  // Stats de uso
  timesUsed Int       @default(0)
  lastUsed  DateTime?

  createdAt DateTime @default(now())

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId, emotionType, intensity])
  @@index([agentId, timesUsed])
  @@index([provider])
}

// ============================================
// SISTEMA DE GENERACIN LOCAL (FastSD CPU)
// ============================================

// ESTADO DE INSTALACIN DE FASTSD POR USUARIO
model FastSDInstallation {
  id     String @id @default(cuid())
  userId String @unique

  // Estado de instalaci贸n
  installed   Boolean @default(false)
  installPath String? // Ruta de instalaci贸n
  version     String? // Versi贸n instalada

  // Estado del servidor
  serverRunning   Boolean   @default(false)
  serverUrl       String    @default("http://localhost:8000")
  lastHealthCheck DateTime?

  // Modelos instalados
  installedModels Json? // Array de modelos disponibles
  activeModel     String? // Modelo actualmente activo

  // Configuraci贸n
  device             String  @default("CPU") // "CPU", "GPU", "NPU"
  useOpenVINO        Boolean @default(true)
  useTinyAutoencoder Boolean @default(true)

  // Aprobaciones y consentimientos
  userApprovedInstallation Boolean   @default(false)
  installationRequestedAt  DateTime?
  installationCompletedAt  DateTime?
  installationError        String?   @db.Text

  // Estad铆sticas de uso
  totalGenerations    Int    @default(0)
  totalGenerationTime Float  @default(0.0) // Segundos totales
  avgGenerationTime   Float? // Promedio de tiempo por imagen

  // Metadata
  metadata Json? // Configuraci贸n adicional

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([installed])
  @@index([serverRunning])
}

// IMPORTANT EVENTS - Eventos importantes que la IA debe recordar
// La IA decide qu茅 guardar usando comandos [REMEMBER:...]
model ImportantEvent {
  id      String @id @default(cuid())
  agentId String
  userId  String

  // Informaci贸n del evento
  eventDate   DateTime // Fecha del evento
  type        String // birthday, medical, exam, special, anniversary, other
  description String   @db.Text // "Cirug铆a de Max (perro)", "Cumplea帽os del usuario"
  priority    String   @default("medium") // low, medium, high, critical

  // Estado del evento
  mentioned        Boolean  @default(false) // Ya la IA pregunt贸 sobre esto?
  reminderSentAt   DateTime? // Cu谩ndo se mencion贸 por 煤ltima vez
  eventHappened    Boolean  @default(false) // El evento ya pas贸?
  userFeedback     String? // "Fue bien", "Se cancel贸", etc.
  isRecurring      Boolean  @default(false) // Se repite cada a帽o? (cumplea帽os, aniversarios)
  recurringDay     Int? // D铆a del mes (1-31) para eventos recurrentes
  recurringMonth   Int? // Mes (1-12) para eventos recurrentes

  // Metadata
  relationship String? // user, family, pet, friend (a qui茅n afecta)
  emotionalTone String? // joyful, anxious, neutral, sad
  metadata     Json? // Info adicional flexible

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([userId])
  @@index([eventDate])
  @@index([mentioned])
  @@index([type])
}

// IMPORTANT PEOPLE - Personas importantes que la IA debe recordar
// La IA detecta personas mediante comandos [PERSON:...]
model ImportantPerson {
  id      String @id @default(cuid())
  agentId String
  userId  String

  // Informaci贸n b谩sica
  name         String // "Ana", "Max", "Mam谩"
  relationship String // "hermana", "pareja", "amigo", "madre", "mascota", "compa帽ero de trabajo"
  age          Int? // Edad aproximada
  gender       String? // "male", "female", "other", "unknown"

  // Contexto
  description String? @db.Text // "Vive en C贸rdoba, estudia medicina"
  interests   String? @db.Text // "Le gusta el anime, el gaming"
  healthInfo  String? @db.Text // "Tiene diabetes", "Se recupera de cirug铆a"

  // Metadata
  birthday     DateTime? // Cumplea帽os de la persona
  lastMentioned DateTime? // ltima vez que el usuario habl贸 de esta persona
  mentionCount  Int @default(0) // Cu谩ntas veces se mencion贸
  importance    String @default("medium") // low, medium, high (basado en frecuencia de menci贸n)

  metadata Json? // Info adicional flexible

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([userId])
  @@index([name])
  @@index([relationship])
  @@index([lastMentioned])
}

// PROACTIVE MESSAGING - Sistema de iniciativa conversacional
// Permite que el agente env铆e mensajes espont谩neos al usuario

model ProactiveConfig {
  id      String @id @default(cuid())
  agentId String @unique
  userId  String

  // Configuraci贸n general
  enabled              Boolean @default(true) // Usuario permite mensajes proactivos?
  maxMessagesPerDay    Int     @default(2) // L铆mite diario de mensajes proactivos
  maxMessagesPerWeek   Int     @default(7) // L铆mite semanal
  quietHoursStart      Int?    @default(22) // Hora de inicio de horario silencioso (22 = 10 PM)
  quietHoursEnd        Int?    @default(8) // Hora de fin de horario silencioso (8 = 8 AM)

  // Triggers habilitados
  inactivityEnabled    Boolean @default(true) // Enviar mensaje si usuario inactivo?
  inactivityDays       Int     @default(3) // D铆as de inactividad antes de enviar
  eventRemindersEnabled Boolean @default(true) // Recordar eventos pr贸ximos?
  eventReminderHours   Int     @default(24) // Horas antes del evento para recordar
  emotionalCheckInEnabled Boolean @default(true) // Check-in emocional si 煤ltima conversaci贸n fue dif铆cil?

  // Metadata
  lastProactiveMessage DateTime? // ltima vez que se envi贸 mensaje proactivo
  timezone             String    @default("America/Argentina/Buenos_Aires")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([userId])
  @@index([enabled])
}

model ProactiveMessage {
  id      String @id @default(cuid())
  agentId String
  userId  String

  // Informaci贸n del mensaje
  triggerType String // "inactivity", "event_reminder", "emotional_checkin", "conversation_followup"
  content     String @db.Text // Contenido del mensaje generado
  context     Json? // Contexto usado para generar el mensaje (evento, 煤ltima conversaci贸n, etc.)

  // Estado
  status        String   @default("pending") // pending, sent, delivered, read, failed
  sentAt        DateTime?
  deliveredAt   DateTime?
  readAt        DateTime?
  responseAt    DateTime? // Cu谩ndo respondi贸 el usuario?
  userResponded Boolean  @default(false)

  // Relaci贸n con mensaje real (si se envi贸)
  messageId String? @unique // ID del mensaje en la tabla Message

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([agentId])
  @@index([userId])
  @@index([status])
  @@index([triggerType])
  @@index([sentAt])
  @@index([createdAt])
}
