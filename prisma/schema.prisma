// This is your Prisma schema file for "Creador de Inteligencias"
// Sistema dual de IAs emocionales (Compa침eros) y administrativas (Asistentes)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Modelo de Usuario
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  plan          String    @default("free") // free, premium, enterprise
  apiKey        String?   // API key opcional para usuarios avanzados
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  agents   Agent[]
  worlds   World[]
  accounts Account[]
  sessions Session[]

  @@index([email])
}

// NextAuth Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Modelo de Agente (IA)
model Agent {
  id           String   @id @default(cuid())
  userId       String
  kind         String   // companion (emocional) o assistant (administrativo)
  name         String
  description  String?
  gender       String?
  personality  String?
  tone         String?
  purpose      String?
  profile      Json     // JSON con toda la configuraci칩n del agente
  systemPrompt String   @db.Text
  visibility   String   @default("private") // private, world, public
  avatar       String?  // URL o identificador de avatar
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  worldAgents      WorldAgent[]
  messagesAsAgent  Message[]       @relation("AgentMessages")
  relationsSubject Relation[]      @relation("SubjectRelations")

  @@index([userId])
  @@index([kind])
}

// Modelo de Mundo (entorno grupal)
model World {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  worldAgents WorldAgent[]
  messages    Message[]

  @@index([userId])
}

// Tabla intermedia para Mundos y Agentes
model WorldAgent {
  worldId  String
  agentId  String
  joinedAt DateTime @default(now())

  world World @relation(fields: [worldId], references: [id], onDelete: Cascade)
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@id([worldId, agentId])
}

// Modelo de Relaciones (emocionales entre agentes o usuario-agente)
model Relation {
  id            String   @id @default(cuid())
  subjectId     String   // ID del agente que siente la relaci칩n
  targetId      String   // ID del agente o usuario objetivo
  targetType    String   // "agent" o "user" - indica el tipo de objetivo
  trust         Float    @default(0.5) // Confianza (0-1)
  affinity      Float    @default(0.5) // Afinidad (0-1)
  respect       Float    @default(0.5) // Respeto (0-1)
  privateState  Json     // Estados ocultos: love, curiosity, etc.
  visibleState  Json     // Estados visibles para el usuario
  updatedAt     DateTime @updatedAt

  subjectAgent Agent @relation("SubjectRelations", fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([subjectId, targetId])
  @@index([subjectId])
  @@index([targetId])
  @@index([targetType])
}

// Modelo de Mensajes
model Message {
  id        String   @id @default(cuid())
  worldId   String?  // Si es en un mundo grupal
  agentId   String?  // Si es chat individual
  userId    String?  // Usuario que envi칩 el mensaje
  role      String   // user, assistant, system
  content   String   @db.Text
  metadata  Json?    // Datos adicionales (emociones, contexto, etc.)
  createdAt DateTime @default(now())

  world World? @relation(fields: [worldId], references: [id], onDelete: Cascade)
  agent Agent? @relation("AgentMessages", fields: [agentId], references: [id], onDelete: Cascade)

  @@index([worldId])
  @@index([agentId])
  @@index([createdAt])
}

// Modelo de Logs (para panel administrativo)
model Log {
  id          String   @id @default(cuid())
  userId      String?
  agentId     String?
  action      String   // message_sent, agent_created, world_created, etc.
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([agentId])
  @@index([createdAt])
}
