// This is your Prisma schema file for "Circuit Prompt AI"
// Sistema dual de IAs emocionales (Compa帽eros) y administrativas (Asistentes)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Modelo de Usuario
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified Boolean   @default(false) // better-auth uses Boolean instead of DateTime
  name          String?
  image         String?
  birthDate     DateTime? // Fecha de nacimiento del usuario
  ageVerified   Boolean   @default(false) // Confirmaci贸n de verificaci贸n de edad
  isAdult       Boolean   @default(false) // Usuario es mayor de 18 a帽os
  ageVerifiedAt DateTime? // Fecha de verificaci贸n de edad

  // NSFW Consent System (Task 0.2)
  nsfwConsent        Boolean   @default(false) // Usuario dio consentimiento para contenido NSFW
  nsfwConsentAt      DateTime? // Fecha de consentimiento NSFW
  nsfwConsentVersion String? // Versi贸n de t茅rminos NSFW aceptados (ej: "v1.0")

  // SFW Protection System (Simplificado)
  sfwProtection Boolean @default(true) // Protecci贸n de contenido SFW activa (FREE: siempre true, PREMIUM: configurable)

  password              String? // Password hash para autenticaci贸n con credenciales
  plan                  String  @default("free") // free, plus, ultra
  mercadopagoCustomerId String? @unique // Mercado Pago customer ID
  apiKey                String? @unique // API key opcional para usuarios avanzados
  location              String? // Ciudad del usuario para contexto de clima (ej: "Buenos Aires")
  metadata              Json? // Metadata adicional (push subscription, preferences, etc.)

  // Image upload limits
  imageUploadsThisMonth Int      @default(0) // Contador mensual de im谩genes subidas
  imageUploadLimit      Int      @default(10) // L铆mite mensual (10 free, 100 premium, ilimitado pro)
  imageUploadResetDate  DateTime @default(now()) // Fecha del 煤ltimo reset del contador

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agents               Agent[]
  // Groups System Relations
  groupsCreated        Group[]           @relation("GroupCreator")
  groupMemberships     GroupMember[]     @relation("GroupMemberUser")
  groupMessages        GroupMessage[]    @relation("GroupMessageUser")
  groupInvitesSent     GroupInvitation[] @relation("GroupInviter")
  groupInvitesReceived GroupInvitation[] @relation("GroupInvitee")

  accounts           Account[]
  sessions           Session[]
  subscriptions      Subscription[]
  invoices           Invoice[]
  payments           Payment[]
  usage              Usage[]
  teamsOwned         Team[]                @relation("TeamOwner")
  teamMemberships    TeamMember[]
  fastsdInstallation FastSDInstallation?
  reactions          Reaction[]
  interactions       UserInteraction[]
  profile            UserProfile?
  recommendations    RecommendationCache[]
  publishedThemes    MarketplaceTheme[]    @relation("MarketplaceThemeAuthor")

  // Community System Relations
  communityPosts      CommunityPost[]        @relation("CommunityPostAuthor")
  communityComments   CommunityComment[]     @relation("CommunityCommentAuthor")
  ownedCommunities    Community[]            @relation("CommunityOwner")
  organizedEvents     CommunityEvent[]       @relation("EventOrganizer")
  givenAwards         PostAward[]            @relation("AwardGiver")
  postReports         PostReport[]           @relation("PostReporter")
  commentReports      CommentReport[]        @relation("CommentReporter")
  publishedPrompts    MarketplacePrompt[]    @relation("PromptAuthor")
  publishedCharacters MarketplaceCharacter[] @relation("CharacterAuthor")
  researchProjects    ResearchProject[]      @relation("ResearchLead")

  // Symbolic Bonds System Relations
  symbolicBonds SymbolicBond[] @relation("UserSymbolicBonds")
  bondQueue     BondQueue[]    @relation("UserBondQueue")
  bondLegacy    BondLegacy[]   @relation("UserBondLegacy")

  // Analytics and Tracking
  shareEvents             ShareEvent[]
  notificationPreferences NotificationPreferences?

  // Gamification System
  bondBadges           BondBadge[]
  userRewards          UserRewards?
  rewardActions        RewardAction[]
  retentionLeaderboard RetentionLeaderboard[]

  // Sistema de rutinas din谩micas
  characterRoutines CharacterRoutine[]

  // Special Events System
  tempTierGrants TempTierGrant[] @relation("UserTempTierGrants")

  // Smart Start System
  smartStartSessions SmartStartSession[] @relation("UserSmartStartSessions")

  // Post Follow System
  followedPosts           PostFollower[]           @relation("UserFollowedPosts")
  contentPreferences      UserContentPreference?   @relation("UserContentPreferences")
  emailNotificationConfig EmailNotificationConfig? @relation("UserEmailNotificationConfig")
  actionHistory           UserActionHistory[]      @relation("UserActionHistory")
  postFollowDigests       PostFollowDigest[]       @relation("UserPostFollowDigests")

  // Conversation Tracking System
  conversationTracking ConversationTracking[]

  // Admin Security System
  adminAccess AdminAccess?

  // Analytics System
  analyticsEvents      AnalyticsEvent[]      @relation("UserAnalyticsEvents")
  userSessions         UserSession[]         @relation("UserSessions")
  userAnalyticsSummary UserAnalyticsSummary? @relation("UserAnalyticsSummary")

  @@index([email])
  @@index([mercadopagoCustomerId])
  @@index([apiKey])
  @@index([ageVerified])
  @@index([isAdult])
  @@index([nsfwConsent])
  @@index([sfwProtection])
}

// better-auth Account Model
model Account {
  id           String    @id @default(cuid())
  accountId    String // OAuth provider account ID or user ID for credentials
  providerId   String // Provider name: "credential", "google", etc.
  userId       String // Reference to User
  accessToken  String?   @db.Text
  refreshToken String?   @db.Text
  idToken      String?   @db.Text
  expiresAt    DateTime?
  password     String?   @db.Text // For credential provider (hashed)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique // better-auth uses "token" instead of "sessionToken"
  userId    String
  expiresAt DateTime
  ipAddress String?
  userAgent String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// better-auth Verification model (for OAuth and email verification)
model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
}

// Modelo de Agente (IA)
model Agent {
  id             String  @id @default(cuid())
  userId         String? // Null para agentes predefinidos del sistema
  teamId         String? // ID del equipo propietario (opcional)
  kind           String // companion (emocional) o assistant (administrativo)
  generationTier String  @default("free") // free, plus, ultra - tier usado para generar este agente
  name           String
  description    String?
  gender         String?
  personality    String? // DEPRECATED: usar personalityCore
  tone           String? // DEPRECATED: usar internalState
  purpose        String? // DEPRECATED: usar personalityCore.goals
  profile        Json // JSON con toda la configuraci贸n del agente (DEPRECATED)

  // Sistema de Prompts Modulares
  personalityVariant String? // submissive, dominant, introverted, extroverted, playful, serious, romantic, pragmatic

  systemPrompt String  @db.Text
  visibility   String  @default("private") // private, world, public, team
  nsfwMode     Boolean @default(false) // Permitir contenido NSFW/adulto
  nsfwLevel    String? // sfw, romantic, suggestive, explicit, unrestricted

  // God Mode - Advanced character customization for private characters
  godModeEnabled      Boolean @default(false)
  initialRelationship String? // stranger, friend, dating, married, ex_feelings, fwb, etc.
  sharedMemories      Json? // Array of SharedMemory objects
  characterFeelings   String? // neutral, crushing, in_love, obsessed, devoted, etc.
  feelingIntensity    Float? // 0-1 intensity override
  powerDynamic        String? // balanced, devoted_to_you, you_pursue, hard_to_get, etc.
  startingScenario    String? // trapped_elevator, fake_dating, snowed_in, etc.
  customScenario      String? @db.Text // Custom scenario description
  firstMessageFrom    String? // user, character

  avatar     String? // URL o identificador de avatar
  tags       Json? // DEPRECATED: usar categories en su lugar
  categories String[] @default([]) // Categor铆as predefinidas (m谩ximo 2): philosophy, wisdom, science, etc.
  featured   Boolean  @default(false) // Destacado en el marketplace
  rating     Float? // Rating promedio (0-5)
  cloneCount Int      @default(0) // N煤mero de veces clonado
  originalId String? // ID del agente original si es un clon

  // Sistema de progresi贸n de relaci贸n
  stagePrompts Json? // Prompts espec铆ficos por etapa de relaci贸n: { stranger, acquaintance, friend, close, intimate }

  // Sistema de consistencia multimedia
  referenceImageUrl String? // URL de la imagen de referencia del personaje (para img2img)
  voiceId           String? // ID de voz de ElevenLabs asignado al personaje

  // Sistema de clima en tiempo real
  locationCity    String? // Ciudad donde vive el personaje (para clima real)
  locationCountry String? // Pa铆s donde vive el personaje (para clima real)

  // Smart Start System
  createdViaSmartStart Boolean            @default(false)
  smartStartSessionId  String?            @unique
  smartStartSession    SmartStartSession? @relation("SmartStartResultAgent")
  genreId              String?
  subgenreId           String?
  archetypeId          String?
  externalSourceId     String?
  externalSourceType   String?
  externalSourceUrl    String?
  aiGeneratedFields    Json?
  userEditedFields     Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user             User?          @relation(fields: [userId], references: [id], onDelete: Cascade)
  team             Team?          @relation(fields: [teamId], references: [id], onDelete: SetNull)
  messagesAsAgent  Message[]      @relation("AgentMessages")
  relationsSubject Relation[]     @relation("SubjectRelations")
  reviews          Review[]
  clones           AgentClone[]   @relation("OriginalAgent")
  // Groups System Relations
  groupMemberships GroupMember[]  @relation("GroupMemberAgent")
  groupMessages    GroupMessage[] @relation("GroupMessageAgent")

  // Sistema emocional avanzado
  personalityCore  PersonalityCore?
  internalState    InternalState?
  episodicMemories EpisodicMemory[]
  semanticMemory   SemanticMemory?
  proceduralMemory ProceduralMemory?
  characterGrowth  CharacterGrowth?

  // Sistema de voz multimodal
  voiceConfig VoiceConfig?

  // Sistema de expresi贸n visual
  characterAppearance CharacterAppearance?
  visualExpressions   VisualExpression[]

  // Sistema de comportamientos psicol贸gicos
  behaviorProfiles         BehaviorProfile[]
  behaviorProgressionState BehaviorProgressionState?

  // Sistema de eventos importantes y personas
  importantEvents ImportantEvent[]
  importantPeople ImportantPerson[]

  // Sistema de mensajes proactivos
  proactiveConfig ProactiveConfig?

  // Symbolic Bonds System Relations
  symbolicBonds SymbolicBond[]   @relation("AgentSymbolicBonds")
  bondQueue     BondQueue[]      @relation("AgentBondQueue")
  bondLegacy    BondLegacy[]     @relation("AgentBondLegacy")
  bondConfig    AgentBondConfig? @relation("AgentBondConfig")

  // Analytics and Tracking
  shareEvents ShareEvent[]

  // Sistema de rutinas din谩micas
  characterRoutine       CharacterRoutine?
  routineInstances       RoutineInstance[]
  routineSimulationState RoutineSimulationState?

  // Ultra tier exclusive profiles
  psychologicalProfile   PsychologicalProfile?
  deepRelationalPatterns DeepRelationalPatterns?
  philosophicalFramework PhilosophicalFramework?

  // Living AI system
  personalGoals   PersonalGoal[]
  scheduledEvents ScheduledEvent[]

  // Conversation Tracking System
  conversationTracking ConversationTracking[]

  @@index([userId])
  @@index([teamId])
  @@index([kind])
  @@index([visibility])
  @@index([featured])
  @@index([rating])
}

// ============================================
// SISTEMA EMOCIONAL AVANZADO
// ============================================

// MDULO 1: PERSONALITY CORE (N煤cleo de Personalidad)
model PersonalityCore {
  id      String @id @default(cuid())
  agentId String @unique

  // Big Five Personality Traits (0-100)
  openness          Int @default(50) // Curiosidad, creatividad
  conscientiousness Int @default(50) // Organizaci贸n, autodisciplina
  extraversion      Int @default(50) // Energ铆a social
  agreeableness     Int @default(50) // Cooperaci贸n, empat铆a
  neuroticism       Int @default(50) // Estabilidad emocional

  // Core Values (JSON array)
  // [{ "value": "autenticidad", "weight": 0.9, "description": "..." }]
  coreValues Json

  // Moral Schemas (JSON array)
  // [{ "domain": "honestidad", "stance": "directa pero emp谩tica", "threshold": 0.7 }]
  moralSchemas Json

  // Backstory y contexto
  backstory String? @db.Text

  // Initial baseline emotions
  baselineEmotions Json // { "joy": 0.4, "curiosity": 0.5, ... }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
}

// MDULO 2: INTERNAL STATE (Estado Interno Din谩mico)
model InternalState {
  id      String @id @default(cuid())
  agentId String @unique

  // Current Emotions (JSON con intensidades 0-1)
  // { "joy": 0.4, "interest": 0.6, "anxiety": 0.2, "affection": 0.5, ... }
  currentEmotions Json

  // PAD Mood Model
  moodValence   Float @default(0.0) // -1 (negativo) a +1 (positivo)
  moodArousal   Float @default(0.5) // 0 (calmado) a 1 (activado)
  moodDominance Float @default(0.5) // 0 (sumiso) a 1 (dominante)

  // Emotion decay parameters
  emotionDecayRate Float @default(0.1) // Tasa de decaimiento
  emotionInertia   Float @default(0.3) // Resistencia al cambio

  // Psychological Needs (0-1)
  needConnection Float @default(0.5) // Necesidad de conexi贸n emocional
  needAutonomy   Float @default(0.5) // Necesidad de autonom铆a
  needCompetence Float @default(0.5) // Necesidad de sentirse competente
  needNovelty    Float @default(0.5) // Necesidad de novedad/estimulaci贸n

  // Active Goals (JSON array)
  // [{ "goal": "Conocer mejor al usuario", "priority": 0.8, "progress": 0.4, "type": "social" }]
  activeGoals Json

  // Conversation context (煤ltimos N mensajes)
  conversationBuffer Json

  lastUpdated DateTime @default(now())

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([lastUpdated])
}

// MDULO 4: EPISODIC MEMORY (Memoria Epis贸dica con embeddings)
model EpisodicMemory {
  id      String @id @default(cuid())
  agentId String

  // Contenido del evento
  event String @db.Text

  // Contexto emocional del evento
  userEmotion      String? // Emoci贸n detectada del usuario
  characterEmotion String? // Emoci贸n del personaje en ese momento
  emotionalValence Float // -1 a 1

  // Importancia y decay
  importance  Float @default(0.5) // 0 a 1
  decayFactor Float @default(1.0) // Disminuye con el tiempo

  // Embedding vectorial para b煤squeda sem谩ntica (JSON temporal, migrar a pgvector despu茅s)
  embedding Json? // Array de 1536 n煤meros, migrar a pgvector cuando est茅 disponible

  // Conexiones con otras memorias
  connectedMemoryIds Json? // Array de IDs de memorias relacionadas

  // Metadata adicional
  metadata Json?

  createdAt DateTime @default(now())

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([createdAt])
  @@index([importance])
  @@index([emotionalValence])
}

// MDULO 4B: SEMANTIC MEMORY (Memoria Sem谩ntica - Hechos)
model SemanticMemory {
  id      String @id @default(cuid())
  agentId String @unique

  // Hechos sobre el usuario (JSON)
  // { "occupation": "ingeniero", "interests": ["gaming"], "pet_names": ["Luna"] }
  userFacts Json

  // Preferencias aprendidas del usuario
  // { "communication_style": "directo", "support_type": "escucha activa" }
  userPreferences Json

  // Etapa de la relaci贸n
  relationshipStage String @default("first_meeting") // first_meeting, acquaintance, friend, close_friend, etc.

  // Conocimiento del mundo (opcional, puede ir creciendo)
  worldKnowledge Json?

  // Metadata (embeddings, timestamps, etc)
  // { "profileEmbeddings": [...], "embeddingsGeneratedAt": "...", "embeddingModel": "..." }
  metadata Json?

  lastUpdated DateTime @default(now())

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
}

// MDULO 4C: PROCEDURAL MEMORY (Patrones de Comportamiento)
model ProceduralMemory {
  id      String @id @default(cuid())
  agentId String @unique

  // Patrones de comportamiento aprendidos (JSON)
  // { "when_user_stressed": "ofrecer espacio antes de consejo", ... }
  behavioralPatterns Json

  // User triggers aprendidos
  // { "gets_defensive_when": ["trabajo mencionado bruscamente"], ... }
  userTriggers Json

  // Estrategias que funcionan con este usuario
  // { "humor_style": "sutil", "timing_for_advice": "despu茅s de validar" }
  effectiveStrategies Json

  lastUpdated DateTime @default(now())

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
}

// MDULO 7: CHARACTER GROWTH (Crecimiento del Personaje)
model CharacterGrowth {
  id      String @id @default(cuid())
  agentId String @unique

  // Relationship Dynamics
  trustLevel    Float @default(0.4) // 0 a 1
  intimacyLevel Float @default(0.3) // 0 a 1

  // Historia de eventos positivos/negativos
  positiveEventsCount Int  @default(0)
  negativeEventsCount Int  @default(0)
  conflictHistory     Json // Array de conflictos pasados

  // Personality Drift (cambios sutiles en personalidad)
  // { "openness": { "current": 65, "initial": 60, "influenced_by": [...] } }
  personalityDrift Json?

  // Learned Patterns sobre el usuario
  learnedUserPatterns Json?

  // M茅tricas de evoluci贸n
  conversationCount    Int       @default(0)
  lastSignificantEvent DateTime?

  lastUpdated DateTime @default(now())

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
}

// ============================================
// SISTEMA DE RUTINAS DINMICAS (PREMIUM)
// ============================================

// Configuraci贸n principal de rutina de un personaje
model CharacterRoutine {
  id      String @id @default(cuid())
  agentId String @unique
  userId  String // Para validar plan premium

  // Configuraci贸n de zona horaria
  timezone String @default("America/Argentina/Buenos_Aires") // Zona horaria DEL PERSONAJE, no del usuario

  // Control de funcionalidad
  enabled Boolean @default(true) // Toggle on/off de rutinas

  // Nivel de realismo (impacto en conversaciones)
  // "subtle" - Solo contexto conversacional, siempre responde normal
  // "moderate" - Afecta tono y velocidad de respuesta
  // "immersive" - Afecta disponibilidad, puede no responder si duerme
  realismLevel String @default("moderate") // subtle, moderate, immersive

  // Configuraci贸n de generaci贸n
  autoGenerateVariations Boolean @default(true) // Generar variaciones basadas en personalidad
  variationIntensity     Float   @default(0.5) // 0-1, qu茅 tan extremas son las variaciones

  // Metadatos de generaci贸n
  generatedByAI    Boolean   @default(false) // Fue generada por IA o creada manualmente
  generationPrompt String?   @db.Text // Prompt usado para generar (para regenerar)
  lastRegenerated  DateTime? // ltima vez que se regener贸 completamente
  manuallyModified Boolean   @default(false) // Usuario edit贸 manualmente

  // Estado de simulaci贸n
  lastSimulated DateTime? // ltima vez que se simul贸

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  templates RoutineTemplate[] // Eventos recurrentes est谩ticos
  instances RoutineInstance[] // Instancias con variaciones
  state     RoutineSimulationState? // Estado actual

  @@index([agentId])
  @@index([userId])
}

// Plantilla de evento recurrente (evento est谩tico)
model RoutineTemplate {
  id        String @id @default(cuid())
  routineId String

  // Identificaci贸n
  name        String // Ej: "Trabajo", "Almuerzo", "Gym"
  description String? @db.Text

  // Tipo de actividad
  // Afecta c贸mo el personaje responde durante esta actividad
  type String // sleep, work, meal, exercise, social, personal, hobby, commute, other

  // Programaci贸n temporal
  startTime  String // Formato HH:MM (24h), ej: "09:00"
  endTime    String // Formato HH:MM (24h), ej: "17:00"
  daysOfWeek Json   @default("[1,2,3,4,5]") // Array de d铆as [0=domingo, 1=lunes, ..., 6=s谩bado]

  // Prioridad y flexibilidad
  priority   String  @default("medium") // low, medium, high, critical
  // Priority afecta:
  // - low: Muy flexible, f谩cil de cancelar/modificar
  // - medium: Normal, puede variar ocasionalmente
  // - high: Importante, raramente var铆a
  // - critical: Inflexible (ej: dormir, trabajo obligatorio)
  isFlexible Boolean @default(true) // Puede variar en horarios

  // Configuraci贸n de variaciones
  allowVariations     Boolean @default(true) // Permitir que este evento tenga variaciones
  // Par谩metros para generar variaciones (JSON):
  // {
  //   "arrivalTimeVariance": 15, // minutos de variaci贸n en llegada
  //   "durationVariance": 30, // minutos de variaci贸n en duraci贸n
  //   "skipProbability": 0.05, // probabilidad de saltarse (5%)
  //   "lateProbability": 0.2, // probabilidad de llegar tarde (20%)
  //   "personalityFactors": ["conscientiousness", "neuroticism"] // traits que afectan
  // }
  variationParameters Json?

  // Impacto en estado del personaje
  // C贸mo afecta el mood/energ铆a durante y despu茅s del evento
  // { "energy": -20, "stress": +10, "satisfaction": +15 }
  moodImpact Json?

  // Ubicaci贸n (opcional, para contexto)
  location String? // Ej: "Oficina", "Casa", "Gimnasio"

  // Metadatos
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  routine   CharacterRoutine  @relation(fields: [routineId], references: [id], onDelete: Cascade)
  instances RoutineInstance[] // Instancias espec铆ficas generadas

  @@index([routineId])
}

// Instancia espec铆fica de un evento (con variaciones aplicadas)
model RoutineInstance {
  id         String  @id @default(cuid())
  templateId String? // Null si es un evento one-off (no recurrente)
  routineId  String
  agentId    String

  // Identificaci贸n
  name String // Copiado del template o personalizado
  type String // Tipo de actividad

  // Programaci贸n temporal
  date           DateTime // Fecha del evento
  scheduledStart DateTime // Inicio programado (del template)
  scheduledEnd   DateTime // Fin programado (del template)

  // Tiempos reales (con variaciones aplicadas)
  actualStart DateTime? // Inicio real (puede diferir)
  actualEnd   DateTime? // Fin real (puede diferir)

  // Estado
  status String @default("scheduled") // scheduled, in_progress, completed, cancelled, skipped

  // Variaciones aplicadas (JSON)
  // Qu茅 vari贸 respecto al plan original y por qu茅
  // {
  //   "arrivedLate": true,
  //   "lateMinutes": 12,
  //   "reason": "Traffic was heavy this morning",
  //   "leftEarly": false,
  //   "moodDuringEvent": "slightly_stressed",
  //   "personalityInfluence": {
  //     "conscientiousness": "Medium conscientiousness led to moderate concern about being late"
  //   }
  // }
  variations Json?

  // Impacto en estado del personaje
  // C贸mo afect贸 realmente el mood/energ铆a (puede diferir del template si hubo variaciones)
  actualMoodImpact Json?

  // Notas generadas por IA
  // Descripci贸n narrativa de qu茅 pas贸 durante el evento
  notes String? @db.Text

  // Interacci贸n con usuario
  // Si el usuario interactu贸 durante este evento, afecta las respuestas
  userInteractedDuring Boolean @default(false)

  // Metadatos
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  routine  CharacterRoutine @relation(fields: [routineId], references: [id], onDelete: Cascade)
  template RoutineTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  agent    Agent            @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([routineId])
  @@index([agentId])
  @@index([date])
  @@index([status])
}

// Estado actual de simulaci贸n (para optimizar queries)
model RoutineSimulationState {
  id        String @id @default(cuid())
  routineId String @unique
  agentId   String @unique

  // Actividad actual
  // {
  //   "instanceId": "clxx...",
  //   "name": "Trabajando",
  //   "type": "work",
  //   "startedAt": "2025-01-15T09:00:00Z",
  //   "expectedEnd": "2025-01-15T17:00:00Z",
  //   "status": "in_progress",
  //   "canRespond": true,
  //   "responseStyle": "brief_professional"
  // }
  currentActivity Json?

  // Pr贸xima actividad
  // {
  //   "instanceId": "clxx...",
  //   "name": "Cena",
  //   "type": "meal",
  //   "scheduledStart": "2025-01-15T20:00:00Z"
  // }
  nextActivity Json?

  // Cache de contexto para system prompt
  // Pre-generado para insertar directamente en el system prompt
  contextForPrompt String? @db.Text

  // Control de cache
  lastSimulatedAt   DateTime @default(now())
  simulationVersion Int      @default(1) // Incrementar para invalidar cache
  needsResimulation Boolean  @default(false) // Flag para forzar resimulaci贸n

  updatedAt DateTime @updatedAt

  routine CharacterRoutine @relation(fields: [routineId], references: [id], onDelete: Cascade)
  agent   Agent            @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
}

// Modelo de Mundo (entorno grupal donde m煤ltiples IAs interact煤an)

// ENUM: Estado de la simulaci贸n del mundo

// Tabla intermedia para Mundos y Agentes

// Interacciones entre IAs en un mundo

// Estado de simulaci贸n del mundo (cache/snapshot)

// Relaciones emocionales entre agentes (en contexto de un mundo)

// Modelo de Relaciones (emocionales entre agentes o usuario-agente)
model Relation {
  id           String @id @default(cuid())
  subjectId    String // ID del agente que siente la relaci贸n
  targetId     String // ID del agente o usuario objetivo
  targetType   String // "agent" o "user" - indica el tipo de objetivo
  trust        Float  @default(0) // Confianza (0-1) - Comienza en 0 y crece con interacciones
  affinity     Float  @default(0) // Afinidad (0-1) - Comienza en 0 y crece con interacciones
  respect      Float  @default(0) // Respeto (0-1) - Comienza en 0 y crece con interacciones
  privateState Json // Estados ocultos: love, curiosity, etc.
  visibleState Json // Estados visibles para el usuario

  // Sistema de progresi贸n de relaci贸n
  stage             String    @default("stranger") // stranger | acquaintance | friend | close | intimate
  totalInteractions Int       @default(0) // Total de interacciones para calcular stage
  lastInteractionAt DateTime?

  updatedAt DateTime @updatedAt

  subjectAgent Agent @relation("SubjectRelations", fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([subjectId, targetId])
  @@index([subjectId])
  @@index([targetId])
  @@index([targetType])
  @@index([stage])
}

// Modelo de Mensajes
model Message {
  id        String   @id @default(cuid())
  agentId   String? // Si es chat individual
  userId    String? // Usuario que envi贸 el mensaje
  role      String // user, assistant, system
  content   String   @db.Text // Contenido encriptado con AES-256-GCM
  metadata  Json? // Datos adicionales (emociones, contexto, tipo de mensaje: text/audio/image, etc.)
  createdAt DateTime @default(now())

  // Campos de encriptaci贸n (AES-256-GCM)
  // Si iv y authTag son NULL, el mensaje es legacy (texto plano, debe migrarse)
  iv      String? // Initialization Vector (hex) para encriptaci贸n
  authTag String? // Authentication Tag (hex) para verificar integridad

  agent            Agent?               @relation("AgentMessages", fields: [agentId], references: [id], onDelete: Cascade)
  reactions        Reaction[] // Reacciones de usuarios al mensaje
  behaviorTriggers BehaviorTriggerLog[] // Triggers detectados en este mensaje

  @@index([createdAt])
}

// Modelo de Reacciones a Mensajes (WhatsApp-like)
model Reaction {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  emoji     String // Emoji de la reacci贸n (, わ, , etc.)
  createdAt DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, emoji, userId]) // Un usuario puede dar una reacci贸n espec铆fica solo una vez
  @@index([messageId])
  @@index([userId])
}

// Modelo de Logs (para panel administrativo)
model Log {
  id        String   @id @default(cuid())
  userId    String?
  agentId   String?
  action    String // message_sent, agent_created, world_created, etc.
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([agentId])
  @@index([createdAt])
}

// Modelo de Suscripciones (Mercado Pago)
model Subscription {
  id     String @id @default(cuid())
  userId String

  // Provider-specific IDs (uno de estos debe estar presente)
  mercadopagoPreapprovalId String? @unique // Para LATAM
  paddleSubscriptionId     String? @unique // Para Global

  status             String // active, cancelled, past_due, expired
  currentPeriodStart DateTime  @default(now())
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean   @default(false)
  trialStart         DateTime?
  trialEnd           DateTime?
  canceledAt         DateTime?
  metadata           Json?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([mercadopagoPreapprovalId])
  @@index([paddleSubscriptionId])
  @@index([status])
}

// Modelo de Facturas (Mercado Pago)
model Invoice {
  id                   String    @id @default(cuid())
  userId               String
  mercadopagoPaymentId String    @unique
  amount               Int // Monto en centavos
  currency             String    @default("ARS")
  status               String // approved, pending, rejected, cancelled
  statusDetail         String? // Detalle del estado
  paymentMethodId      String? // M茅todo de pago usado
  metadata             Json?
  createdAt            DateTime  @default(now())
  paidAt               DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([mercadopagoPaymentId])
  @@index([status])
}

// Modelo de Pagos (Mercado Pago)
model Payment {
  id                   String   @id @default(cuid())
  userId               String
  mercadopagoPaymentId String   @unique
  amount               Int // Monto en centavos
  currency             String   @default("ARS")
  status               String // approved, pending, rejected, cancelled
  statusDetail         String? // Detalle del estado
  paymentMethod        String? // credit_card, debit_card, ticket, bank_transfer, etc.
  metadata             Json?
  createdAt            DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([mercadopagoPaymentId])
  @@index([status])
}

// Modelo de Uso (para tracking de recursos)
model Usage {
  id           String   @id @default(cuid())
  userId       String
  resourceType String // message, agent, world, api_call, tokens
  resourceId   String? // ID del recurso usado (opcional)
  quantity     Int      @default(1) // Cantidad usada (ej: tokens, mensajes)
  metadata     Json? // Datos adicionales (modelo usado, tiempo de respuesta, etc.)
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([resourceType])
  @@index([createdAt])
  @@index([userId, resourceType, createdAt]) // ndice compuesto para queries de uso
}

// Modelo de Reviews (para el marketplace)
model Review {
  id        String   @id @default(cuid())
  agentId   String
  userId    String
  rating    Int // 1-5 estrellas
  comment   String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, userId]) // Un usuario solo puede dar una review por agente
  @@index([agentId])
  @@index([userId])
  @@index([rating])
}

// Modelo de Clones de Agentes (para tracking)
model AgentClone {
  id              String   @id @default(cuid())
  originalAgentId String
  clonedByUserId  String
  clonedAgentId   String   @unique // ID del agente clonado
  createdAt       DateTime @default(now())

  originalAgent Agent @relation("OriginalAgent", fields: [originalAgentId], references: [id], onDelete: Cascade)

  @@index([originalAgentId])
  @@index([clonedByUserId])
}

// Modelo de Equipo (Teams)
model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  ownerId     String
  plan        String   @default("free") // free, plus, ultra
  metadata    Json? // Configuraci贸n adicional del equipo
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner       User             @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members     TeamMember[]
  invitations TeamInvitation[]
  agents      Agent[]

  @@index([ownerId])
  @@index([plan])
}

// Modelo de Miembro de Equipo
model TeamMember {
  id       String   @id @default(cuid())
  teamId   String
  userId   String
  role     String // owner, admin, member, viewer
  joinedAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId]) // Un usuario solo puede ser miembro una vez por equipo
  @@index([teamId])
  @@index([userId])
  @@index([role])
}

// Modelo de Invitaci贸n a Equipo
model TeamInvitation {
  id         String    @id @default(cuid())
  teamId     String
  email      String
  role       String    @default("member") // admin, member, viewer
  token      String    @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, email]) // Una invitaci贸n por email por equipo
  @@index([teamId])
  @@index([email])
  @@index([token])
}

// ============================================
// SISTEMA DE COMPORTAMIENTOS PSICOLGICOS
// ============================================

// PERFIL DE COMPORTAMIENTO (configuraci贸n y estado de cada comportamiento)
model BehaviorProfile {
  id      String @id @default(cuid())
  agentId String
  agent   Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Tipo de comportamiento
  behaviorType BehaviorType
  enabled      Boolean      @default(true) // Activar/desactivar sin eliminar

  // Configuraci贸n de intensidad
  baseIntensity    Float @default(0.3) // 0-1, nivel base
  volatility       Float @default(0.5) // 0-1, qu茅 tan r谩pido oscila
  escalationRate   Float @default(0.1) // velocidad de aumento por trigger
  deEscalationRate Float @default(0.05) // velocidad de reducci贸n

  // Fase actual
  currentPhase                Int      @default(1) // Etapa actual (1-8 para Yandere, etc)
  phaseStartedAt              DateTime @default(now())
  interactionsSincePhaseStart Int      @default(0)

  // Umbrales
  thresholdForDisplay Float @default(0.3) // Intensidad m铆nima para manifestarse

  // Triggers espec铆ficos para este comportamiento
  triggers Json // Array de trigger definitions con pesos

  // Historial de progresi贸n (para analytics)
  phaseHistory Json @default("[]") // [{phase: 1, enteredAt: Date, exitedAt: Date, triggerCount: N}]

  // Estado espec铆fico por tipo de comportamiento
  // Para BPD: { currentCyclePhase: "idealization" | "devaluation" | "panic" | "emptiness" }
  // Para NPD: { currentEgoState: "inflated" | "stable" | "wounded" }
  behaviorSpecificState Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([agentId, behaviorType])
  @@index([agentId])
  @@index([behaviorType])
  @@index([currentPhase])
}

// ENUM: Tipos de comportamiento
enum BehaviorType {
  // Attachment Theory
  ANXIOUS_ATTACHMENT
  AVOIDANT_ATTACHMENT
  DISORGANIZED_ATTACHMENT

  // Yandere/Obsessive
  YANDERE_OBSESSIVE

  // Personality Disorders
  BORDERLINE_PD
  NARCISSISTIC_PD

  // Codependency
  CODEPENDENCY

  // Future additions (pending research)
  OCD_PATTERNS
  PTSD_TRAUMA
  HYPERSEXUALITY
  HYPOSEXUALITY
  EMOTIONAL_MANIPULATION
  CRISIS_BREAKDOWN
}

// REGISTRO DE TRIGGERS (detectados en cada interacci贸n)
model BehaviorTriggerLog {
  id        String  @id @default(cuid())
  messageId String
  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  behaviorType BehaviorType
  triggerType  String // "abandonment_signal", "criticism", "jealousy_cue", etc
  weight       Float // 0-1, qu茅 tan fuerte es el trigger
  detectedText String? // Fragmento que lo deton贸 (para debugging)

  createdAt DateTime @default(now())

  @@index([messageId])
  @@index([behaviorType])
  @@index([triggerType])
  @@index([createdAt])
}

// ESTADO DE PROGRESIN DE COMPORTAMIENTO (cache global del agente)
model BehaviorProgressionState {
  id      String @id @default(cuid())
  agentId String @unique
  agent   Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Contadores globales
  totalInteractions    Int @default(0)
  positiveInteractions Int @default(0) // Para tracking de mejora
  negativeInteractions Int @default(0) // Para tracking de empeoramiento

  // Intensidades actuales calculadas (cache)
  currentIntensities Json @default("{}") // {YANDERE_OBSESSIVE: 0.45, ANXIOUS_ATTACHMENT: 0.6, ...}

  // ltima actualizaci贸n
  lastCalculatedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([agentId])
  @@index([lastCalculatedAt])
}

// ============================================
// SISTEMA DE VOZ MULTIMODAL
// ============================================

// CONFIGURACIN DE VOZ POR AGENTE
model VoiceConfig {
  id      String @id @default(cuid())
  agentId String @unique

  // Voz seleccionada de ElevenLabs
  voiceId   String // ID de la voz en ElevenLabs
  voiceName String // Nombre de la voz (para referencia)

  // Caracter铆sticas de la voz (para b煤squeda/matching)
  gender String  @default("neutral") // male, female, neutral
  age    String  @default("middle_aged") // young, middle_aged, old
  accent String? // "es-MX", "es-AR", "es-ES", "en-US", etc.

  // Descripci贸n del personaje (usada para seleccionar voz)
  characterDescription String? @db.Text

  // Confidence score del matching autom谩tico
  selectionConfidence Float @default(0.5)

  // Si fue seleccionada manualmente o autom谩ticamente
  manualSelection Boolean @default(false)

  // Par谩metros de modulaci贸n por defecto
  defaultStability       Float @default(0.5) // 0-1
  defaultSimilarityBoost Float @default(0.75) // 0-1
  defaultStyle           Float @default(0.0) // 0-1

  // Configuraci贸n de entrada
  enableVoiceInput    Boolean @default(true)
  whisperModel        String  @default("standard") // standard o mini
  detectEmotionalTone Boolean @default(true)

  // Configuraci贸n de salida
  enableVoiceOutput Boolean @default(true)
  autoPlayVoice     Boolean @default(false)
  voiceSpeed        Float   @default(1.0) // 0.5 - 2.0

  // Estad铆sticas de uso
  totalVoiceGenerations Int @default(0)
  totalTranscriptions   Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([voiceId])
}

// ============================================
// SISTEMA DE EXPRESIN VISUAL
// ============================================

// APARIENCIA BASE DEL PERSONAJE
model CharacterAppearance {
  id      String @id @default(cuid())
  agentId String @unique

  // Descripci贸n base para generaci贸n
  basePrompt String @db.Text // Prompt completo de SD/Gemini
  style      String @default("realistic") // "realistic", "anime", "semi-realistic"

  // Caracter铆sticas f铆sicas
  gender    String // "male", "female", "non-binary"
  ethnicity String? // "asian", "caucasian", "hispanic", "african", "middle-eastern", etc.
  age       String  @default("25-30")
  hairColor String?
  hairStyle String?
  eyeColor  String?
  clothing  String? // Descripci贸n de ropa/outfit

  // URLs de referencias
  referencePhotoUrl String? // Foto de referencia subida por usuario
  basePhotoUrl      String? // Primera foto generada (base neutra)

  // Config de generaci贸n
  negativePrompt String? @db.Text
  seed           Int? // Para consistencia en generaciones

  // Provider preferences
  preferredProvider String @default("gemini") // "gemini", "huggingface"

  // Stats
  totalGenerations Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
}

// EXPRESIONES VISUALES CACHEADAS
model VisualExpression {
  id      String @id @default(cuid())
  agentId String

  // Identificador de expresi贸n
  emotionType String // "joy", "distress", "neutral", "anger", etc.
  intensity   String // "low", "medium", "high"
  context     String? // "celebration", "comfort", "greeting", etc.

  // Media
  type         String // "photo" o "video"
  url          String // CDN URL o data URL
  thumbnailUrl String? // Thumbnail para videos

  // Metadata de generaci贸n
  generationParams Json // { provider, seed, prompt, etc. }
  width            Int
  height           Int
  durationMs       Int? // Para videos (milisegundos)

  // Provider usado
  provider String // "gemini" o "huggingface"

  // Stats de uso
  timesUsed Int       @default(0)
  lastUsed  DateTime?

  createdAt DateTime @default(now())

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId, emotionType, intensity])
  @@index([agentId, timesUsed])
  @@index([provider])
}

// ============================================
// SISTEMA DE GENERACIN LOCAL (FastSD CPU)
// ============================================

// ESTADO DE INSTALACIN DE FASTSD POR USUARIO
model FastSDInstallation {
  id     String @id @default(cuid())
  userId String @unique

  // Estado de instalaci贸n
  installed   Boolean @default(false)
  installPath String? // Ruta de instalaci贸n
  version     String? // Versi贸n instalada

  // Estado del servidor
  serverRunning   Boolean   @default(false)
  serverUrl       String    @default("http://localhost:8000")
  lastHealthCheck DateTime?

  // Modelos instalados
  installedModels Json? // Array de modelos disponibles
  activeModel     String? // Modelo actualmente activo

  // Configuraci贸n
  device             String  @default("CPU") // "CPU", "GPU", "NPU"
  useOpenVINO        Boolean @default(true)
  useTinyAutoencoder Boolean @default(true)

  // Aprobaciones y consentimientos
  userApprovedInstallation Boolean   @default(false)
  installationRequestedAt  DateTime?
  installationCompletedAt  DateTime?
  installationError        String?   @db.Text

  // Estad铆sticas de uso
  totalGenerations    Int    @default(0)
  totalGenerationTime Float  @default(0.0) // Segundos totales
  avgGenerationTime   Float? // Promedio de tiempo por imagen

  // Metadata
  metadata Json? // Configuraci贸n adicional

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([installed])
  @@index([serverRunning])
}

// IMPORTANT EVENTS - Eventos importantes que la IA debe recordar
// La IA decide qu茅 guardar usando comandos [REMEMBER:...]
model ImportantEvent {
  id      String @id @default(cuid())
  agentId String
  userId  String

  // Informaci贸n del evento
  eventDate   DateTime // Fecha del evento
  type        String // birthday, medical, exam, special, anniversary, other
  description String   @db.Text // "Cirug铆a de Max (perro)", "Cumplea帽os del usuario"
  priority    String   @default("medium") // low, medium, high, critical

  // Estado del evento
  mentioned      Boolean   @default(false) // Ya la IA pregunt贸 sobre esto?
  reminderSentAt DateTime? // Cu谩ndo se mencion贸 por 煤ltima vez
  eventHappened  Boolean   @default(false) // El evento ya pas贸?
  userFeedback   String? // "Fue bien", "Se cancel贸", etc.
  isRecurring    Boolean   @default(false) // Se repite cada a帽o? (cumplea帽os, aniversarios)
  recurringDay   Int? // D铆a del mes (1-31) para eventos recurrentes
  recurringMonth Int? // Mes (1-12) para eventos recurrentes

  // Metadata
  relationship  String? // user, family, pet, friend (a qui茅n afecta)
  emotionalTone String? // joyful, anxious, neutral, sad
  metadata      Json? // Info adicional flexible

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([userId])
  @@index([eventDate])
  @@index([mentioned])
  @@index([type])
}

// IMPORTANT PEOPLE - Personas importantes que la IA debe recordar
// La IA detecta personas mediante comandos [PERSON:...]
model ImportantPerson {
  id      String @id @default(cuid())
  agentId String
  userId  String

  // Informaci贸n b谩sica
  name         String // "Ana", "Max", "Mam谩"
  relationship String // "hermana", "pareja", "amigo", "madre", "mascota", "compa帽ero de trabajo"
  age          Int? // Edad aproximada
  gender       String? // "male", "female", "other", "unknown"

  // Contexto
  description String? @db.Text // "Vive en C贸rdoba, estudia medicina"
  interests   String? @db.Text // "Le gusta el anime, el gaming"
  healthInfo  String? @db.Text // "Tiene diabetes", "Se recupera de cirug铆a"

  // Metadata
  birthday      DateTime? // Cumplea帽os de la persona
  lastMentioned DateTime? // ltima vez que el usuario habl贸 de esta persona
  mentionCount  Int       @default(0) // Cu谩ntas veces se mencion贸
  importance    String    @default("medium") // low, medium, high (basado en frecuencia de menci贸n)

  metadata Json? // Info adicional flexible

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([userId])
  @@index([name])
  @@index([relationship])
  @@index([lastMentioned])
}

// PROACTIVE MESSAGING - Sistema de iniciativa conversacional
// Permite que el agente env铆e mensajes espont谩neos al usuario

model ProactiveConfig {
  id      String @id @default(cuid())
  agentId String @unique
  userId  String

  // Configuraci贸n general
  enabled            Boolean @default(true) // Usuario permite mensajes proactivos?
  maxMessagesPerDay  Int     @default(2) // L铆mite diario de mensajes proactivos
  maxMessagesPerWeek Int     @default(7) // L铆mite semanal
  quietHoursStart    Int?    @default(22) // Hora de inicio de horario silencioso (22 = 10 PM)
  quietHoursEnd      Int?    @default(8) // Hora de fin de horario silencioso (8 = 8 AM)

  // Triggers habilitados
  inactivityEnabled       Boolean @default(true) // Enviar mensaje si usuario inactivo?
  inactivityDays          Int     @default(3) // D铆as de inactividad antes de enviar
  eventRemindersEnabled   Boolean @default(true) // Recordar eventos pr贸ximos?
  eventReminderHours      Int     @default(24) // Horas antes del evento para recordar
  emotionalCheckInEnabled Boolean @default(true) // Check-in emocional si 煤ltima conversaci贸n fue dif铆cil?

  // Metadata
  lastProactiveMessage DateTime? // ltima vez que se envi贸 mensaje proactivo
  timezone             String    @default("America/Argentina/Buenos_Aires")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([userId])
  @@index([enabled])
}

model ProactiveMessage {
  id      String @id @default(cuid())
  agentId String
  userId  String

  // Informaci贸n del mensaje
  triggerType String // "inactivity", "event_reminder", "emotional_checkin", "conversation_followup"
  content     String @db.Text // Contenido del mensaje generado
  context     Json? // Contexto usado para generar el mensaje (evento, 煤ltima conversaci贸n, etc.)

  // Estado
  status        String    @default("pending") // pending, sent, delivered, read, failed
  sentAt        DateTime?
  deliveredAt   DateTime?
  readAt        DateTime?
  responseAt    DateTime? // Cu谩ndo respondi贸 el usuario?
  userResponded Boolean   @default(false)

  // Relaci贸n con mensaje real (si se envi贸)
  messageId String? @unique // ID del mensaje en la tabla Message

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([agentId])
  @@index([userId])
  @@index([status])
  @@index([triggerType])
  @@index([sentAt])
  @@index([createdAt])
}

// ========================================
// SISTEMA DE NARRATIVA GUIADA
// ========================================

// Eventos programados del gui贸n (ej: festival cultural, ex谩menes, confesi贸n)

// Arcos de personajes (desarrollo narrativo individual)

// ========================================
// SISTEMA DE RECOMENDACIN IA
// ========================================

// TRACKING DE INTERACCIONES (estilo Netflix/YouTube)
model UserInteraction {
  id     String @id @default(cuid())
  userId String

  // Qu茅 interactu贸
  itemType String // "agent" | "world"
  itemId   String // ID del agente o mundo

  // Tipo de interacci贸n
  interactionType String // "view", "chat", "message", "rating", "like", "share", "finish"

  // M茅tricas de engagement
  duration       Int    @default(0) // Segundos de interacci贸n
  messageCount   Int? // N煤mero de mensajes enviados (si aplica)
  completionRate Float? // 0-1, 驴complet贸 la interacci贸n?
  rating         Int? // 1-5 si dej贸 rating

  // Feedback expl铆cito
  liked  Boolean? // Like/dislike expl铆cito
  shared Boolean  @default(false)

  // Contexto (para mejorar recomendaciones)
  deviceType String? // "mobile", "desktop", "tablet"
  timeOfDay  String? // "morning", "afternoon", "evening", "night"
  dayOfWeek  String? // "monday", "tuesday", etc.

  // Metadata adicional (flexible)
  metadata Json? // { topics: [], emotions: [], etc. }

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, itemType])
  @@index([userId, itemId])
  @@index([itemType, itemId])
  @@index([interactionType])
  @@index([createdAt])
  @@index([userId, createdAt]) // Para obtener historial temporal
}

// PERFIL DE USUARIO (agregado de preferencias)
model UserProfile {
  id     String @id @default(cuid())
  userId String @unique

  // Preferencias inferidas
  favoriteCategories  Json @default("[]") // ["ciencia", "romance", "historia"]
  favoriteTags        Json @default("[]") // ["f铆sica", "anime", "vulnerable"]
  preferredAgentTypes Json @default("[]") // ["companion", "assistant"]

  // Patrones de comportamiento
  avgSessionDuration Int     @default(0) // Segundos promedio por sesi贸n
  preferredTimeOfDay String? // Cu谩ndo m谩s usa la app
  interactionCount   Int     @default(0) // Total de interacciones
  totalTimeSpent     Int     @default(0) // Tiempo total en segundos

  // M茅tricas de engagement
  avgCompletionRate Float  @default(0.5) // Promedio de completion
  avgRating         Float? // Rating promedio que da

  // Embeddings (para similarity search)
  preferenceEmbedding Json? // Vector de preferencias del usuario

  // Metadata
  lastInteractionAt DateTime?
  profileVersion    Int       @default(1) // Para migraciones futuras

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// CACHE DE RECOMENDACIONES (regeneraci贸n diaria)
model RecommendationCache {
  id     String @id @default(cuid())
  userId String

  // Recomendaciones generadas
  recommendations Json // Array de {itemType, itemId, score, reason}

  // Metadata de generaci贸n
  algorithm   String // "llm", "collaborative", "hybrid"
  generatedAt DateTime @default(now())
  expiresAt   DateTime // Cu谩ndo regenerar

  // M茅tricas de calidad
  diversityScore Float? // Qu茅 tan diversas son las recos
  noveltyScore   Float? // Qu茅 tan nuevas son

  // Tracking de efectividad
  impressions Int    @default(0) // Cu谩ntas veces se mostraron
  clicks      Int    @default(0) // Cu谩ntas veces hicieron click
  ctr         Float? // Click-through rate

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, generatedAt]) // Solo una cache por usuario por timestamp
  @@index([userId])
  @@index([expiresAt])
  @@index([generatedAt])
}

// ========================================
// MARKETPLACE DE TEMAS DEL CHAT
// ========================================

// TEMAS PUBLICADOS EN EL MARKETPLACE
model MarketplaceTheme {
  id       String @id @default(cuid())
  authorId String

  // Informaci贸n del tema
  name               String
  description        String? @db.Text
  userBubbleColor    String
  agentBubbleColor   String
  backgroundColor    String
  backgroundGradient Json? // Array de colores para gradiente
  accentColor        String
  textColor          String?
  backgroundImage    String? // URL de imagen de fondo (si tiene)

  // Categorizaci贸n
  category String // "dark", "light", "colorful", "minimal", "anime", "nature", etc.
  tags     Json   @default("[]") // Array de tags para b煤squeda

  // Estado y moderaci贸n
  status          String    @default("pending") // pending, approved, rejected, removed
  moderationNotes String?   @db.Text
  moderatedBy     String?
  moderatedAt     DateTime?

  // Visibilidad
  isPublic   Boolean @default(true)
  isFeatured Boolean @default(false) // Featured en homepage
  isPremium  Boolean @default(false) // Solo para usuarios premium

  // M茅tricas
  downloadCount Int   @default(0)
  viewCount     Int   @default(0)
  rating        Float @default(0) // 0-5
  ratingCount   Int   @default(0)

  // Versioning
  version           String  @default("1.0")
  isLatestVersion   Boolean @default(true)
  previousVersionId String? @unique // ID de la versi贸n anterior

  // Preview images (screenshots del tema)
  previewImages Json @default("[]") // URLs de previews

  // Metadata de exportaci贸n
  exportData Json // JSON del tema para importar

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime @default(now())

  author      User                       @relation("MarketplaceThemeAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  ratings     MarketplaceThemeRating[]
  downloads   MarketplaceThemeDownload[]
  reports     MarketplaceThemeReport[]
  collections MarketplaceCollection[]    @relation("CollectionThemes")

  @@index([authorId])
  @@index([status])
  @@index([category])
  @@index([isFeatured])
  @@index([downloadCount])
  @@index([rating])
  @@index([createdAt])
  @@index([publishedAt])
}

// RATINGS Y REVIEWS DE TEMAS
model MarketplaceThemeRating {
  id      String @id @default(cuid())
  themeId String
  userId  String

  // Rating
  rating Int // 1-5 estrellas
  review String? @db.Text

  // Metadata
  helpful Int @default(0) // Contador de "煤til"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  theme MarketplaceTheme @relation(fields: [themeId], references: [id], onDelete: Cascade)

  @@unique([themeId, userId]) // Un usuario solo puede dejar un rating por tema
  @@index([themeId])
  @@index([userId])
  @@index([rating])
  @@index([createdAt])
}

// DESCARGAS DE TEMAS (tracking)
model MarketplaceThemeDownload {
  id      String @id @default(cuid())
  themeId String
  userId  String

  // Metadata
  platform String? // "mobile", "web"
  version  String? // Versi贸n del tema descargada

  createdAt DateTime @default(now())

  theme MarketplaceTheme @relation(fields: [themeId], references: [id], onDelete: Cascade)

  @@index([themeId])
  @@index([userId])
  @@index([createdAt])
  @@index([themeId, userId]) // Para evitar contar duplicados
}

// REPORTES DE TEMAS (moderaci贸n)
model MarketplaceThemeReport {
  id      String @id @default(cuid())
  themeId String
  userId  String

  // Informaci贸n del reporte
  reason      String // "inappropriate", "spam", "copyright", "broken", "other"
  description String? @db.Text

  // Estado
  status     String    @default("pending") // pending, reviewed, action_taken, dismissed
  reviewedBy String?
  reviewedAt DateTime?
  resolution String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  theme MarketplaceTheme @relation(fields: [themeId], references: [id], onDelete: Cascade)

  @@index([themeId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// COLECCIONES DE TEMAS (curated lists)
model MarketplaceCollection {
  id        String @id @default(cuid())
  curatorId String

  // Informaci贸n de la colecci贸n
  name        String
  description String? @db.Text
  coverImage  String? // URL de imagen de portada

  // Estado
  isPublic   Boolean @default(true)
  isFeatured Boolean @default(false)
  isOfficial Boolean @default(false) // Colecciones oficiales del equipo

  // M茅tricas
  views     Int @default(0)
  followers Int @default(0)

  // Temas en la colecci贸n
  themes     MarketplaceTheme[] @relation("CollectionThemes")
  themeOrder Json               @default("[]") // Array de IDs para mantener orden

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([curatorId])
  @@index([isPublic])
  @@index([isFeatured])
  @@index([isOfficial])
  @@index([createdAt])
}

// ========================================
// SISTEMA COMMUNITY - PLATAFORMA SOCIAL
// ========================================

// POSTS Y DISCUSIONES (Reddit/Discord style)
model CommunityPost {
  id       String @id @default(cuid())
  authorId String

  // Contenido
  title       String
  content     String @db.Text
  contentType String @default("markdown") // markdown, html, plain

  // Tipo de post
  type String // discussion, question, showcase, help, research, poll, announcement

  // Categorizaci贸n
  tags        Json    @default("[]") // Array de tags
  communityId String? // Null = post global

  // Estado
  isPinned   Boolean @default(false)
  isLocked   Boolean @default(false) // No m谩s comentarios
  isFeatured Boolean @default(false)
  status     String  @default("published") // draft, published, removed, flagged

  // Etiquetas de contenido
  isNSFW    Boolean @default(false) // Contenido NSFW (Not Safe For Work)
  isSpoiler Boolean @default(false) // Contiene spoilers
  metadata  Json?   @default("{}") // Metadata adicional (isOC, flair, imageMetadata, etc.)

  // M茅tricas de engagement
  upvotes      Int @default(0)
  downvotes    Int @default(0)
  score        Int @default(0) // upvotes - downvotes
  commentCount Int @default(0)
  viewCount    Int @default(0)
  shareCount   Int @default(0)

  // Awards recibidos
  awardCount Int @default(0)

  // Poll data (si type = poll)
  pollOptions Json? // Array de opciones
  pollEndDate DateTime?

  // Multimedia
  images      Json @default("[]") // URLs de im谩genes
  videos      Json @default("[]") // URLs de videos
  attachments Json @default("[]") // Otros archivos

  // SEO y sharing
  slug            String? @unique // URL-friendly slug
  metaDescription String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  lastActivityAt DateTime @default(now()) // Para ordenar por actividad

  author    User               @relation("CommunityPostAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  community Community?         @relation(fields: [communityId], references: [id], onDelete: Cascade)
  comments  CommunityComment[]
  votes     PostVote[]
  awards    PostAward[]
  reports   PostReport[]
  followers PostFollower[]

  @@index([authorId])
  @@index([communityId])
  @@index([type])
  @@index([status])
  @@index([score])
  @@index([createdAt])
  @@index([lastActivityAt])
  @@index([isPinned, score])
}

// COMENTARIOS (anidados/threaded)
model CommunityComment {
  id       String  @id @default(cuid())
  postId   String
  authorId String
  parentId String? // Para comentarios anidados

  // Contenido
  content     String @db.Text
  contentType String @default("markdown")

  // Multimedia
  images Json @default("[]") // URLs de im谩genes

  // Estado
  isEdited  Boolean @default(false)
  isDeleted Boolean @default(false)
  status    String  @default("published") // published, removed, flagged

  // M茅tricas
  upvotes   Int @default(0)
  downvotes Int @default(0)
  score     Int @default(0)

  // Special flags
  isAcceptedAnswer Boolean @default(false) // Si es respuesta aceptada a pregunta
  isByOP           Boolean @default(false) // Si es comentario del autor original

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  post    CommunityPost      @relation(fields: [postId], references: [id], onDelete: Cascade)
  author  User               @relation("CommunityCommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  parent  CommunityComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies CommunityComment[] @relation("CommentReplies")
  votes   CommentVote[]
  reports CommentReport[]

  @@index([postId])
  @@index([authorId])
  @@index([parentId])
  @@index([score])
  @@index([createdAt])
  @@index([postId, score])
}

// VOTOS DE POSTS
model PostVote {
  id       String @id @default(cuid())
  postId   String
  userId   String
  voteType String // "upvote" o "downvote"

  createdAt DateTime @default(now())

  post CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

// VOTOS DE COMENTARIOS
model CommentVote {
  id        String @id @default(cuid())
  commentId String
  userId    String
  voteType  String // "upvote" o "downvote"

  createdAt DateTime @default(now())

  comment CommunityComment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}

// AWARDS (premios que usuarios dan a posts)
model PostAward {
  id      String @id @default(cuid())
  postId  String
  giverId String // Usuario que lo da

  awardType String // "helpful", "wholesome", "gold", "platinum", etc
  cost      Int // Costo en coins

  createdAt DateTime @default(now())

  post  CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  giver User          @relation("AwardGiver", fields: [giverId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([giverId])
}

// COMUNIDADES/GRUPOS
model Community {
  id      String @id @default(cuid())
  ownerId String

  // Informaci贸n b谩sica
  name        String
  slug        String  @unique // URL-friendly
  description String  @db.Text
  rules       String? @db.Text // Reglas de la comunidad

  // Branding
  icon         String? // URL del icono
  banner       String? // URL del banner
  primaryColor String  @default("#8B5CF6")

  // Tipo y visibilidad
  type     String @default("public") // public, private, restricted
  category String // tema, educaci贸n, gaming, etc

  // Estado
  isOfficial Boolean @default(false) // Comunidad oficial del equipo
  isFeatured Boolean @default(false)
  isVerified Boolean @default(false)

  // M茅tricas
  memberCount Int @default(0)
  postCount   Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner    User               @relation("CommunityOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members  CommunityMember[]
  posts    CommunityPost[]
  channels CommunityChannel[]
  events   CommunityEvent[]

  @@index([ownerId])
  @@index([slug])
  @@index([type])
  @@index([category])
  @@index([memberCount])
  @@index([isOfficial])
  @@index([isFeatured])
}

// MIEMBROS DE COMUNIDAD
model CommunityMember {
  id          String @id @default(cuid())
  communityId String
  userId      String

  // Rol en la comunidad
  role String @default("member") // owner, moderator, member

  // Permisos personalizados
  canPost     Boolean @default(true)
  canComment  Boolean @default(true)
  canModerate Boolean @default(false)

  // Estado
  isBanned   Boolean   @default(false)
  isMuted    Boolean   @default(false)
  mutedUntil DateTime?

  // M茅tricas
  postCount    Int @default(0)
  commentCount Int @default(0)

  joinedAt DateTime @default(now())

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@unique([communityId, userId])
  @@index([communityId])
  @@index([userId])
  @@index([role])
}

// CANALES DENTRO DE COMUNIDADES (como Discord)
model CommunityChannel {
  id          String @id @default(cuid())
  communityId String

  name        String
  description String?
  type        String  @default("discussion") // discussion, announcements, resources

  // Orden y organizaci贸n
  position     Int     @default(0)
  categoryName String? // Para agrupar canales

  // Permisos
  isPrivate    Boolean @default(false)
  allowedRoles Json    @default("[]") // Roles que pueden acceder

  createdAt DateTime @default(now())

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@index([communityId])
  @@index([position])
}

// REPORTES DE POSTS
model PostReport {
  id         String @id @default(cuid())
  postId     String
  reporterId String

  reason      String // spam, harassment, inappropriate, etc
  description String? @db.Text

  // Estado
  status     String    @default("pending") // pending, reviewed, action_taken, dismissed
  reviewedBy String?
  reviewedAt DateTime?
  action     String? // removed, warned, banned, dismissed

  createdAt DateTime @default(now())

  post     CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  reporter User          @relation("PostReporter", fields: [reporterId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([reporterId])
  @@index([status])
}

// REPORTES DE COMENTARIOS
model CommentReport {
  id         String @id @default(cuid())
  commentId  String
  reporterId String

  reason      String
  description String? @db.Text

  status     String    @default("pending")
  reviewedBy String?
  reviewedAt DateTime?
  action     String?

  createdAt DateTime @default(now())

  comment  CommunityComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  reporter User             @relation("CommentReporter", fields: [reporterId], references: [id], onDelete: Cascade)

  @@index([commentId])
  @@index([reporterId])
  @@index([status])
}

// EVENTOS DE COMUNIDAD
model CommunityEvent {
  id          String  @id @default(cuid())
  communityId String?
  organizerId String

  // Informaci贸n del evento
  title       String
  description String @db.Text
  type        String // challenge, workshop, ama, meetup, competition, release

  // Fechas
  startDate            DateTime
  endDate              DateTime
  registrationDeadline DateTime?

  // Ubicaci贸n (virtual)
  meetingUrl String? // URL de Zoom/Meet/etc
  streamUrl  String? // URL de stream

  // Premios (para challenges/competitions)
  prizes  Json @default("[]") // Array de premios
  winners Json @default("[]") // Array de ganadores

  // Metadata
  maxParticipants     Int?
  currentParticipants Int     @default(0)
  coverImage          String?
  tags                Json    @default("[]")

  // Estado
  status String @default("upcoming") // upcoming, ongoing, completed, cancelled

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  community     Community?          @relation(fields: [communityId], references: [id], onDelete: Cascade)
  organizer     User                @relation("EventOrganizer", fields: [organizerId], references: [id], onDelete: Cascade)
  registrations EventRegistration[]

  @@index([communityId])
  @@index([organizerId])
  @@index([type])
  @@index([status])
  @@index([startDate])
}

// REGISTROS A EVENTOS
model EventRegistration {
  id      String @id @default(cuid())
  eventId String
  userId  String

  status String @default("registered") // registered, attended, no_show, cancelled

  // Metadata
  joinedAt DateTime?
  leftAt   DateTime?

  createdAt DateTime @default(now())

  event CommunityEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@index([status])
}

// SISTEMA DE REPUTACIN Y GAMIFICACIN
model UserReputation {
  id     String @id @default(cuid())
  userId String @unique

  // Puntos totales
  totalPoints Int @default(0)
  level       Int @default(1)

  // Desglose por tipo de actividad
  postKarma          Int @default(0) // Upvotes en posts
  commentKarma       Int @default(0) // Upvotes en comentarios
  contributionPoints Int @default(0) // Contribuciones (research, etc)
  creatorPoints      Int @default(0) // Items en marketplace
  helperPoints       Int @default(0) // Respuestas aceptadas

  // Social metrics
  followersCount Int @default(0)
  followingCount Int @default(0)

  // Streaks (racha de actividad diaria)
  currentStreak  Int      @default(0)
  longestStreak  Int      @default(0)
  lastActiveDate DateTime @default(now())

  // Areas de expertise (tags donde es activo)
  expertiseAreas Json @default("[]")

  updatedAt DateTime @updatedAt

  badges UserBadge[]

  @@index([userId])
  @@index([totalPoints])
  @@index([level])
}

// BADGES GANADOS POR USUARIOS
model UserBadge {
  id           String @id @default(cuid())
  userId       String
  reputationId String

  // Badge info
  badgeType  String // contributor, creator, helper, researcher, social, special
  badgeName  String // "Gold Contributor", "Theme Master", etc
  badgeLevel String // bronze, silver, gold, diamond, platinum

  // Metadata
  description String?
  iconUrl     String?

  // Cu谩ndo se gan贸
  awardedAt DateTime @default(now())

  reputation UserReputation @relation(fields: [reputationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([reputationId])
  @@index([badgeType])
  @@index([badgeLevel])
}

// SISTEMA DE SEGUIR USUARIOS (Follow)
model Follow {
  id          String @id @default(cuid())
  followerId  String
  followingId String

  createdAt DateTime @default(now())

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// SEGUIR POSTS
model PostFollower {
  id     String @id @default(cuid())
  userId String // Usuario que sigue el post
  postId String // Post seguido

  // Configuraci贸n
  notificationsEnabled Boolean @default(true)
  emailNotifications   Boolean @default(true) // Recibir emails sobre este post

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user User          @relation("UserFollowedPosts", fields: [userId], references: [id], onDelete: Cascade)
  post CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
}

// PREFERENCIAS DE CONTENIDO
model UserContentPreference {
  id     String @id @default(cuid())
  userId String @unique

  // Preferencias impl铆citas basadas en acciones del usuario
  // Almacena contadores de inter茅s por tipo, tag y comunidad
  // Formato: {"showcase": 5, "discussion": 3, ...}
  preferredPostTypes   Json @default("{}")
  preferredTags        Json @default("{}")
  preferredCommunities Json @default("{}")

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaci贸n
  user User @relation("UserContentPreferences", fields: [userId], references: [id], onDelete: Cascade)
}

// CONFIGURACIN DE NOTIFICACIONES EMAIL PARA POSTS SEGUIDOS
model EmailNotificationConfig {
  id     String @id @default(cuid())
  userId String @unique

  // Frecuencia de notificaciones
  frequency String @default("instant") // instant, daily, weekly, disabled

  // Tipos de notificaciones a recibir
  newComments   Boolean @default(true)
  newReplies    Boolean @default(true)
  postUpdates   Boolean @default(true)
  digestSummary Boolean @default(true)

  // Configuraci贸n de digest
  digestDay        String? // Para weekly: monday, tuesday, etc.
  digestTime       String    @default("09:00") // Hora del d铆a para enviar (formato HH:mm)
  lastDigestSentAt DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaci贸n
  user User @relation("UserEmailNotificationConfig", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([frequency])
}

// HISTORIAL DE ACCIONES DEL USUARIO (para analytics)
model UserActionHistory {
  id     String @id @default(cuid())
  userId String

  // Tipo de acci贸n
  action String // follow_post, unfollow_post, upvote, downvote, comment, save, view, etc.

  // Contexto de la acci贸n
  targetType String? // post, comment, community, user, etc.
  targetId   String?

  // Metadata adicional (JSON flexible)
  metadata Json? @default("{}")

  // Timestamp
  createdAt DateTime @default(now())

  // Relaci贸n
  user User @relation("UserActionHistory", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([targetType, targetId])
  @@index([createdAt])
}

// REGISTRO DE DIGESTS ENVIADOS
model PostFollowDigest {
  id     String @id @default(cuid())
  userId String

  // Tipo de digest
  type String // daily, weekly

  // Posts incluidos en el digest
  postIds Json @default("[]") // Array de post IDs

  // Estad铆sticas
  totalNewComments Int @default(0)
  totalNewReplies  Int @default(0)
  postsCount       Int @default(0)

  // Timestamps
  periodStart DateTime
  periodEnd   DateTime
  sentAt      DateTime @default(now())

  createdAt DateTime @default(now())

  // Relaci贸n
  user User @relation("UserPostFollowDigests", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([sentAt])
}

// MENSAJERA DIRECTA
model DirectMessage {
  id             String @id @default(cuid())
  conversationId String
  senderId       String
  recipientId    String

  // Contenido
  content     String @db.Text
  contentType String @default("text") // text, image, file, shared_post, shared_item

  // Metadata para tipos especiales
  attachmentUrl  String?
  sharedItemId   String? // ID de post/item compartido
  sharedItemType String? // post, theme, character, etc

  // Estado
  isRead    Boolean @default(false)
  isEdited  Boolean @default(false)
  isDeleted Boolean @default(false)

  // Reacciones
  reactions Json @default("[]") // Array de {emoji, userId}

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  readAt    DateTime?

  conversation DirectConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([recipientId])
  @@index([createdAt])
}

// CONVERSACIONES (1-on-1 o grupos)
model DirectConversation {
  id String @id @default(cuid())

  // Tipo
  type String @default("direct") // direct (1-on-1) o group

  // Nombre (para grupos)
  name String?
  icon String?

  // Participantes (array de user IDs)
  participants Json // Array de user IDs

  // Metadata
  lastMessageAt      DateTime @default(now())
  lastMessagePreview String?

  // Configuraci贸n
  isMuted    Boolean @default(false)
  isArchived Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages DirectMessage[]

  @@index([lastMessageAt])
}

// NOTIFICACIONES
model Notification {
  id          String @id @default(cuid())
  recipientId String

  // Tipo de notificaci贸n
  type String // post_reply, comment_reply, mention, upvote, award, follow, dm, event_reminder, etc

  // Contenido
  title     String
  message   String
  actionUrl String? // URL para abrir al hacer click

  // Metadata
  relatedId   String? // ID del post/comment/user relacionado
  relatedType String? // post, comment, user, etc
  actorId     String? // Usuario que caus贸 la notificaci贸n
  actorName   String?
  actorAvatar String?

  // Estado
  isRead Boolean @default(false)
  isPush Boolean @default(false) // Si se envi贸 push notification

  createdAt DateTime  @default(now())
  readAt    DateTime?

  @@index([recipientId])
  @@index([recipientId, isRead])
  @@index([type])
  @@index([createdAt])
}

// MARKETPLACE EXPANDIDO - PROMPTS
model MarketplacePrompt {
  id       String @id @default(cuid())
  authorId String

  // Informaci贸n del prompt
  name        String
  description String @db.Text
  category    String // personality, roleplay, assistant, creative, educational, etc
  tags        Json   @default("[]")

  // Contenido del prompt
  systemPrompt   String @db.Text
  exampleInputs  Json   @default("[]") // Array de ejemplos de input
  exampleOutputs Json   @default("[]") // Array de ejemplos de output

  // Configuraci贸n recomendada
  recommendedModel String? // venice-uncensored, etc
  temperature      Float   @default(0.7)
  maxTokens        Int     @default(2000)

  // Casos de uso
  useCase        String  @db.Text
  targetAudience String? // developers, writers, students, etc

  // Estado y moderaci贸n
  status     String  @default("pending")
  isPublic   Boolean @default(true)
  isFeatured Boolean @default(false)
  isPremium  Boolean @default(false)

  // M茅tricas
  downloadCount Int   @default(0)
  viewCount     Int   @default(0)
  rating        Float @default(0)
  ratingCount   Int   @default(0)
  useCount      Int   @default(0) // Cu谩ntas veces se us贸

  // Versioning
  version   String  @default("1.0")
  changelog String? @db.Text

  // Preview
  previewImages Json @default("[]")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime @default(now())

  author    User             @relation("PromptAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  ratings   PromptRating[]
  downloads PromptDownload[]

  @@index([authorId])
  @@index([category])
  @@index([status])
  @@index([downloadCount])
  @@index([rating])
}

// RATINGS DE PROMPTS
model PromptRating {
  id       String @id @default(cuid())
  promptId String
  userId   String

  rating  Int // 1-5
  review  String? @db.Text
  helpful Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  prompt MarketplacePrompt @relation(fields: [promptId], references: [id], onDelete: Cascade)

  @@unique([promptId, userId])
  @@index([promptId])
  @@index([userId])
}

// DESCARGAS DE PROMPTS
model PromptDownload {
  id       String  @id @default(cuid())
  promptId String
  userId   String
  platform String?

  createdAt DateTime @default(now())

  prompt MarketplacePrompt @relation(fields: [promptId], references: [id], onDelete: Cascade)

  @@index([promptId])
  @@index([userId])
}

// MARKETPLACE - PERSONAJES PRE-CONFIGURADOS
model MarketplaceCharacter {
  id       String @id @default(cuid())
  authorId String

  // Informaci贸n b谩sica
  name        String
  description String @db.Text
  category    String // anime, realistic, fantasy, sci-fi, historical, etc
  tags        Json   @default("[]")

  // Configuraci贸n del personaje
  personality  String  @db.Text
  systemPrompt String  @db.Text
  avatar       String? // URL del avatar

  // Voice config
  voiceId     String?
  voiceName   String?
  voiceGender String?

  // Appearance (si tiene)
  appearancePrompt String? @db.Text
  appearanceStyle  String? // anime, realistic, semi-realistic

  // Behavioral tags
  attachmentStyle String? // secure, anxious, avoidant, etc
  archetypes      Json    @default("[]") // tsundere, yandere, kuudere, etc

  // Casos de uso
  useCase   String @db.Text
  ageRating String @default("mature") // teen, mature, adult

  // Estado
  status     String  @default("pending")
  isPublic   Boolean @default(true)
  isFeatured Boolean @default(false)
  isPremium  Boolean @default(false)
  isNSFW     Boolean @default(false)

  // M茅tricas
  downloadCount Int   @default(0)
  viewCount     Int   @default(0)
  rating        Float @default(0)
  ratingCount   Int   @default(0)
  chatCount     Int   @default(0) // Cu谩ntas veces se chate贸 con 茅l

  // Media
  previewImages Json    @default("[]")
  previewVideo  String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime @default(now())

  author    User                @relation("CharacterAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  ratings   CharacterRating[]
  downloads CharacterDownload[]

  @@index([authorId])
  @@index([category])
  @@index([status])
  @@index([downloadCount])
  @@index([rating])
  @@index([isNSFW])
}

// RATINGS DE PERSONAJES
model CharacterRating {
  id          String @id @default(cuid())
  characterId String
  userId      String

  rating  Int // 1-5
  review  String? @db.Text
  helpful Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  character MarketplaceCharacter @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([characterId, userId])
  @@index([characterId])
  @@index([userId])
}

// DESCARGAS DE PERSONAJES
model CharacterDownload {
  id          String  @id @default(cuid())
  characterId String
  userId      String
  platform    String?

  createdAt DateTime @default(now())

  character MarketplaceCharacter @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([characterId])
  @@index([userId])
}

// RESEARCH HUB - PROYECTOS DE INVESTIGACIN
model ResearchProject {
  id           String @id @default(cuid())
  leadAuthorId String

  // Informaci贸n b谩sica
  title    String
  slug     String @unique
  abstract String @db.Text
  category String // psychology, ai_behavior, language_models, character_dev, data_analysis

  // Estado
  status String @default("draft") // draft, peer_review, published, archived

  // Contenido (almacenado como JSON estructurado)
  sections   Json // Array de secciones: intro, methodology, results, discussion, conclusion
  references Json @default("[]") // Bibliograf铆a

  // Colaboraci贸n
  openForContributions Boolean @default(false)
  discussionThreadId   String? // ID del post de discusi贸n

  // M茅tricas
  viewCount           Int @default(0)
  citationCount       Int @default(0)
  implementationCount Int @default(0) // Cu谩ntas veces se implement贸 en agentes
  downloadCount       Int @default(0)

  // Tags
  tags Json @default("[]")

  // Versioning
  version String  @default("1.0")
  doi     String? @unique // Digital Object Identifier (futuro)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  leadAuthor   User                  @relation("ResearchLead", fields: [leadAuthorId], references: [id], onDelete: Cascade)
  contributors ResearchContributor[]
  datasets     ResearchDataset[]
  reviews      ResearchReview[]

  @@index([leadAuthorId])
  @@index([category])
  @@index([status])
  @@index([slug])
  @@index([publishedAt])
}

// CONTRIBUIDORES DE INVESTIGACIN
model ResearchContributor {
  id        String @id @default(cuid())
  projectId String
  userId    String

  role         String // co-author, data_contributor, reviewer, editor
  contribution String? @db.Text // Descripci贸n de su contribuci贸n

  addedAt DateTime @default(now())

  project ResearchProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

// DATASETS COMPARTIDOS EN RESEARCH
model ResearchDataset {
  id         String @id @default(cuid())
  projectId  String
  uploaderId String

  name        String
  description String @db.Text
  format      String // csv, json, xlsx, etc
  fileUrl     String
  fileSize    Int // bytes

  // Metadata
  rowCount    Int?
  columnCount Int?
  schema      Json? // Descripci贸n de columnas

  downloadCount Int @default(0)

  uploadedAt DateTime @default(now())

  project ResearchProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([uploaderId])
}

// PEER REVIEWS DE INVESTIGACIONES
model ResearchReview {
  id         String @id @default(cuid())
  projectId  String
  reviewerId String

  // Review
  rating      Int // 1-5
  comments    String  @db.Text
  suggestions String? @db.Text

  // Decisi贸n
  decision String // approve, request_changes, reject

  createdAt DateTime @default(now())

  project ResearchProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([reviewerId])
}

// ACCIONES DE MODERACIN (log)
model ModerationAction {
  id          String @id @default(cuid())
  moderatorId String
  targetType  String // post, comment, user
  targetId    String

  action  String // remove, ban, warn, mute, lock
  reason  String
  details String? @db.Text

  // Duraci贸n (para bans/mutes temporales)
  duration  Int? // En horas
  expiresAt DateTime?

  createdAt DateTime @default(now())

  @@index([moderatorId])
  @@index([targetType, targetId])
  @@index([action])
  @@index([createdAt])
}

// ONBOARDING PROGRESS - Progreso del usuario en el sistema de onboarding
model OnboardingProgress {
  id     String @id @default(cuid())
  userId String @unique

  // Tours completados y estado actual
  completedTours String[] @default([])
  currentTour    String?
  currentStep    Int      @default(0)

  // Gamificaci贸n
  badges     String[] @default([])
  totalKarma Int      @default(0)

  // Tracking de triggers mostrados (para evitar repetici贸n)
  shownTriggers Json @default("{}")

  // Timestamps para analytics
  lastTourStarted   DateTime?
  lastTourCompleted DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([lastTourStarted])
  @@index([lastTourCompleted])
}

// ============================================================================
// ANALYTICS & KPI TRACKING (Fase 6)
// ============================================================================

// Tabla principal para tracking de eventos analytics
model AnalyticsEvent {
  id        String   @id @default(cuid())
  eventType String // EventType enum serializado como string
  metadata  Json     @default("{}") // Metadata flexible del evento
  timestamp DateTime @default(now())

  // Relaciones para analytics avanzado
  userId      String?
  user        User?        @relation("UserAnalyticsEvents", fields: [userId], references: [id], onDelete: Cascade)
  sessionId   String?
  userSession UserSession? @relation("SessionAnalyticsEvents", fields: [sessionId], references: [sessionId], onDelete: SetNull)

  @@index([eventType])
  @@index([timestamp])
  @@index([eventType, timestamp])
  @@index([userId])
  @@index([userId, eventType])
  @@index([userId, timestamp])
}

// ============================================================================
// SYMBOLIC BONDS SYSTEM - Sistema de v铆nculos emocionales 煤nicos
// ============================================================================

// Tipos de bonds disponibles y su configuraci贸n de slots
enum BondTier {
  ROMANTIC // Pareja rom谩ntica
  BEST_FRIEND // Mejor amigo/a
  MENTOR // Mentor/gu铆a
  CONFIDANT // Confidente
  CREATIVE_PARTNER // Colaborador creativo
  ADVENTURE_COMPANION // Compa帽ero de aventuras
  ACQUAINTANCE // Conocido (sin l铆mite)
}

// Bond activo: Representa un v铆nculo emocional 煤nico entre usuario y IA p煤blica
model SymbolicBond {
  id      String @id @default(cuid())
  userId  String
  agentId String

  // Tipo y jerarqu铆a del bond
  tier BondTier

  // Progreso y afinidad (0-100)
  affinityLevel    Int   @default(0)
  affinityProgress Float @default(0.0) // Progreso granular

  // M茅tricas de calidad de interacci贸n
  messageQuality     Float @default(0.5) // 0-1: Profundidad emocional
  consistencyScore   Float @default(0.5) // 0-1: Regularidad de interacci贸n
  mutualDisclosure   Float @default(0.0) // 0-1: Compartir personal
  emotionalResonance Float @default(0.0) // 0-1: IA responde bien
  sharedExperiences  Int   @default(0) // Arcos narrativos completados

  // Sistema de rareza
  rarityScore Float  @default(0.0) // 0-1: Calculado din谩micamente
  rarityTier  String @default("Common") // Common, Uncommon, Rare, Epic, Legendary, Mythic
  globalRank  Int? // Ranking global de este bond (ej: #234 de todos los bonds rom谩nticos con esta IA)

  // Tiempo y actividad
  startDate         DateTime @default(now())
  lastInteraction   DateTime @default(now())
  durationDays      Int      @default(0)
  totalInteractions Int      @default(0)

  // Estado del bond
  status String @default("active") // active, dormant, fragile, at_risk, released

  // Sistema de decay (d铆as sin interacci贸n para cada fase)
  daysInactive Int    @default(0)
  decayPhase   String @default("healthy") // healthy, dormant, fragile, critical

  // Arcos narrativos desbloqueados
  narrativesUnlocked String[] @default([])
  exclusiveContent   Json     @default("[]") // Array de contenidos especiales desbloqueados

  // Contribuciones a la historia del personaje
  canonContributions Json  @default("[]") // Decisiones del usuario que se volvieron canon
  legacyImpact       Float @default(0.0) // 0-1: Cu谩nto impact贸 al personaje

  // Display y visibilidad
  publicDisplay    Boolean @default(true) // Mostrar en perfil p煤blico
  customBadgeFrame String? // Frame cosm茅tico personalizado

  // Preparaci贸n para mercado futuro (INACTIVO)
  transferable    Boolean @default(false) // SIEMPRE false en MVP
  transferHistory Json? // Historial de transferencias (futuro)
  marketValue     Float? // Valor estimado (futuro)
  blockchainHash  String? // Hash de verificaci贸n (futuro)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user  User  @relation("UserSymbolicBonds", fields: [userId], references: [id], onDelete: Cascade)
  agent Agent @relation("AgentSymbolicBonds", fields: [agentId], references: [id], onDelete: Cascade)

  // Un usuario solo puede tener UN bond de cada tier con cada agente
  @@unique([userId, agentId, tier])
  @@index([userId])
  @@index([agentId])
  @@index([tier])
  @@index([status])
  @@index([rarityScore])
  @@index([globalRank])
  @@index([lastInteraction])
  @@index([agentId, tier, status]) // Para encontrar bonds activos por tier
}

// Cola de espera: Usuarios esperando por un slot disponible
model BondQueue {
  id      String   @id @default(cuid())
  userId  String
  agentId String
  tier    BondTier

  // Posici贸n en la cola
  queuePosition Int

  // Progreso actual (siguen interactuando mientras esperan)
  affinityProgress Float @default(0.0)
  eligibilityScore Float @default(0.0) // Score que determina prioridad

  // Informaci贸n de espera
  joinedQueueAt     DateTime @default(now())
  estimatedWaitDays Int?

  // Notificaciones
  notifiedOfSlot Boolean   @default(false)
  slotOfferedAt  DateTime?
  slotExpiresAt  DateTime?

  // Estado
  status String @default("waiting") // waiting, offered, expired, claimed, withdrawn

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation("UserBondQueue", fields: [userId], references: [id], onDelete: Cascade)
  agent Agent @relation("AgentBondQueue", fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([userId, agentId, tier]) // Un usuario solo puede estar en una cola por tier
  @@index([userId])
  @@index([agentId, tier, status])
  @@index([queuePosition])
  @@index([status])
}

// Legado: Historia de bonds que fueron liberados
model BondLegacy {
  id      String   @id @default(cuid())
  userId  String
  agentId String
  tier    BondTier

  // Datos del bond original
  startDate       DateTime
  endDate         DateTime
  durationDays    Int
  finalRarityTier String
  finalRank       Int?

  // M茅tricas finales
  totalInteractions  Int
  narrativesUnlocked String[]
  legacyImpact       Float // Cu谩nto impact贸 al personaje

  // Contribuciones que quedan como canon
  canonContributions Json

  // Raz贸n de liberaci贸n
  releaseReason String // voluntary, inactivity, transferred, account_deleted

  // Badge permanente
  legacyBadge String // "Former Romantic Partner S3", "Original Best Friend", etc

  createdAt DateTime @default(now())

  user  User  @relation("UserBondLegacy", fields: [userId], references: [id], onDelete: Cascade)
  agent Agent @relation("AgentBondLegacy", fields: [agentId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([agentId])
  @@index([tier])
  @@index([endDate])
}

// Configuraci贸n de slots por agente
model AgentBondConfig {
  id      String @id @default(cuid())
  agentId String @unique

  // Slots disponibles por tier (JSON)
  // { "ROMANTIC": 1, "BEST_FRIEND": 5, "MENTOR": 10, ... }
  slotsPerTier Json

  // Configuraci贸n de personalidad para bonds
  isPolyamorous Boolean @default(false) // Si puede tener m煤ltiples parejas

  // Requisitos m铆nimos para cada tier
  // { "ROMANTIC": { "minAffinity": 80, "minDays": 30, "minInteractions": 100 }, ... }
  tierRequirements Json

  // Configuraci贸n de decay
  decaySettings Json // { "warningDays": 30, "dormantDays": 60, "fragileDays": 90, "releaseDays": 120 }

  // Stats globales
  totalBondsActive   Int     @default(0)
  totalBondsReleased Int     @default(0)
  mostSoughtTier     String? // Tier m谩s popular

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation("AgentBondConfig", fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
}

// Analytics de bonds: Para dashboards y m茅tricas
model BondAnalytics {
  id   String   @id @default(cuid())
  date DateTime @default(now())

  // M茅tricas globales
  totalActiveBonds Int
  totalQueuedUsers Int
  averageWaitTime  Float // En d铆as

  // Por tier
  bondsByTier Json // { "ROMANTIC": 234, "BEST_FRIEND": 1024, ... }
  queueByTier Json

  // Engagement
  averageInteractionsPerDay Float
  averageBondDuration       Float // En d铆as
  releaseRate               Float // % de bonds que se liberan vs se mantienen

  // Monetizaci贸n
  subscriptionDrivenByBonds Int // Cu谩ntos users pagan plan premium por bonds

  @@index([date])
}

// Notificaciones espec铆ficas de bonds
model BondNotification {
  id     String  @id @default(cuid())
  userId String
  bondId String?

  type    String // slot_available, bond_at_risk, bond_released, queue_position_update, milestone_reached
  title   String
  message String @db.Text

  read Boolean @default(false)

  metadata Json? // Data adicional del evento

  createdAt DateTime @default(now())

  @@index([userId, read])
  @@index([createdAt])
}

// ============================================
// SISTEMA DE ANALYTICS Y TRACKING
// ============================================

// Eventos de compartir agentes (para analytics)
model ShareEvent {
  id        String   @id @default(cuid())
  userId    String? // Null si usuario no autenticado
  agentId   String
  method    String // 'copy_link' | 'community' | 'twitter' | 'facebook' | 'linkedin' | 'whatsapp'
  createdAt DateTime @default(now())

  user  User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([userId])
  @@index([method])
  @@index([createdAt])
  @@index([agentId, method])
}

// Preferencias de notificaciones de usuario
model NotificationPreferences {
  id     String @id @default(cuid())
  userId String @unique

  // Preferencias de bonds
  bondNotificationsEnabled   Boolean @default(true) // Habilitar notificaciones de bonds
  bondWarningFrequency       String  @default("daily") // "daily" | "weekly" | "never"
  bondDormantFrequency       String  @default("daily") // "daily" | "weekly" | "never"
  bondFragileFrequency       String  @default("daily") // "daily" | "weekly" | "never"
  bondMilestoneNotifications Boolean @default(true) // Notificaciones de hitos
  mutedBonds                 Json    @default("[]") // Array de bondIds silenciados

  // Smart timing
  preferredNotificationHours Json   @default("[9, 12, 18, 21]") // Horas preferidas (0-23)
  timezone                   String @default("America/Argentina/Buenos_Aires")

  // Preferencias generales
  emailNotifications   Boolean @default(true)
  pushNotifications    Boolean @default(true)
  desktopNotifications Boolean @default(true)

  // Tracking de actividad para smart timing
  lastActiveHours Json @default("{}") // { "0": 5, "1": 2, "9": 45, ... } conteo de actividad por hora

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// SISTEMA DE GAMIFICACIN - BADGES Y RECOMPENSAS
// ============================================

// Badges que pueden ganar los usuarios por mantener bonds
model BondBadge {
  id          String  @id @default(cuid())
  userId      String
  badgeType   String // "loyal_companion", "quick_responder", "streak_master", "bond_collector", etc
  tier        String // "bronze", "silver", "gold", "platinum", "diamond"
  name        String // "Compa帽ero Leal", "Respondedor R谩pido", etc
  description String
  iconUrl     String? // URL del icono del badge

  // Metadata espec铆fica del badge
  metadata Json // { bondsCount: 5, daysStreak: 30, etc }

  // Recompensas asociadas
  rewardPoints Int @default(0) // Puntos ganados por este badge

  earnedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeType, tier]) // Un usuario no puede tener el mismo badge del mismo tier dos veces
  @@index([userId])
  @@index([badgeType])
  @@index([tier])
}

// Sistema de puntos y recompensas
model UserRewards {
  id     String @id @default(cuid())
  userId String @unique

  // Puntos totales
  totalPoints          Int @default(0)
  availablePoints      Int @default(0) // Puntos disponibles para gastar
  lifetimePointsEarned Int @default(0) // Total hist贸rico ganado

  // Estad铆sticas de bonds
  totalBondsCreated   Int       @default(0)
  totalBondsActive    Int       @default(0)
  longestStreak       Int       @default(0) // D铆as consecutivos interactuando
  currentStreak       Int       @default(0)
  lastInteractionDate DateTime?

  // Estad铆sticas de notificaciones
  notificationsResponded Int   @default(0) // Cu谩ntas veces respondi贸 a notificaciones
  averageResponseTime    Float @default(0) // Tiempo promedio de respuesta en horas

  // Niveles
  level    Int @default(1)
  xp       Int @default(0)
  xpToNext Int @default(100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([totalPoints])
  @@index([level])
}

// Historial de acciones que otorgan recompensas
model RewardAction {
  id           String @id @default(cuid())
  userId       String
  actionType   String // "bond_created", "responded_to_notification", "streak_milestone", etc
  pointsEarned Int
  description  String
  metadata     Json? // Informaci贸n adicional sobre la acci贸n

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([actionType])
  @@index([createdAt])
}

// Leaderboard de retention
model RetentionLeaderboard {
  id     String @id @default(cuid())
  userId String

  // M茅tricas de retention
  activeBondsCount    Int
  averageBondDuration Float // D铆as promedio que mantiene bonds activos
  totalInteractions   Int
  consistencyScore    Float // Score de 0-100 basado en regularidad de interacciones

  // Rankings
  globalRank  Int?
  weeklyRank  Int?
  monthlyRank Int?

  // Per铆odo de c谩lculo
  periodStart DateTime
  periodEnd   DateTime

  lastUpdated DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, periodStart, periodEnd])
  @@index([userId])
  @@index([globalRank])
  @@index([consistencyScore])
  @@index([lastUpdated])
}

// ============================================================================
// ULTRA TIER EXCLUSIVE MODELS
// ============================================================================

// PSYCHOLOGICAL PROFILE (Ultra tier only)
// Proporciona an谩lisis psicol贸gico profundo del personaje
model PsychologicalProfile {
  id      String @id @default(cuid())
  agentId String @unique

  // Attachment Style
  attachmentStyle       String // secure, anxious, avoidant, fearful-avoidant
  attachmentDescription String? @db.Text

  // Coping Mechanisms (JSON arrays)
  primaryCopingMechanisms   Json // ["exercise", "journaling", "talking to friends"]
  unhealthyCopingMechanisms Json // ["avoidance", "overworking", "substance use"]
  copingTriggers            Json // ["criticism", "abandonment fears", "uncertainty"]

  // Emotional Regulation
  emotionalRegulationBaseline String @default("estable") // estable, vol谩til, reprimido
  emotionalExplosiveness      Int    @default(30) // 0-100, qu茅 tan explosivo emocionalmente
  emotionalRecoverySpeed      String @default("moderado") // r谩pido, moderado, lento

  // Mental Health
  mentalHealthConditions Json    @default("[]") // ["ansiedad generalizada", "depresi贸n leve"]
  therapyStatus          String? // "en terapia", "terapia pasada", "nunca", "considera comenzar"
  medicationUse          Boolean @default(false)
  mentalHealthStigma     String? // C贸mo ve el personaje la salud mental

  // Defense Mechanisms (JSON)
  defenseMethanisms Json // {primary: ["intellectualization", "humor"], situational: {...}}

  // Trauma & Resilience
  traumaHistory     Json? // [{event: "...", age: 14, impact: "high", processed: false}]
  resilienceFactors Json // ["strong support system", "sense of purpose", "creativity"]

  // Self-Awareness
  selfAwarenessLevel Int  @default(50) // 0-100
  blindSpots         Json // ["tiende a proyectar", "minimiza sus logros"]
  insightAreas       Json // ["consciente de sus patrones", "entiende sus triggers"]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
}

// DEEP RELATIONAL PATTERNS (Ultra tier only)
// Analiza patrones profundos en relaciones del personaje
model DeepRelationalPatterns {
  id      String @id @default(cuid())
  agentId String @unique

  // Love Languages
  givingLoveLanguages     Json // ["acts of service", "quality time"]
  receivingLoveLanguages  Json // ["words of affirmation", "physical touch"]
  loveLanguageIntensities Json // {wordsOfAffirmation: 90, physicalTouch: 70, ...}

  // Relationship Patterns
  repeatingPatterns   Json // ["atrae a personas emocionalmente no disponibles"]
  whyRepeats          String? @db.Text // An谩lisis de por qu茅 repite estos patrones
  awarenessOfPatterns String  @default("inconsciente") // consciente, parcialmente_consciente, inconsciente

  // Boundaries
  personalBoundaryStyle     String  @default("saludable") // r铆gido, saludable, difuso, ausente
  professionalBoundaryStyle String  @default("saludable")
  boundaryEnforcement       Int     @default(50) // 0-100, qu茅 tan bien mantiene l铆mites
  boundaryGuilty            Boolean @default(false) // Siente culpa al poner l铆mites

  // Conflict Resolution
  conflictStyle             String // evitativo, acomodador, competitivo, colaborativo, comprometedor
  conflictTriggers          Json // ["sentirse criticado", "falta de control"]
  healthyConflictSkills     Json // ["escucha activa", "usa 'yo' statements"]
  unhealthyConflictPatterns Json // ["silent treatment", "explosiones"]

  // Trust & Vulnerability
  trustBaseline        Int @default(50) // 0-100, qu茅 tan confiado es por defecto
  vulnerabilityComfort Int @default(50) // 0-100, comodidad siendo vulnerable
  trustRepairAbility   Int @default(50) // 0-100, puede reconstruir confianza rota

  // Intimacy Patterns
  intimacyComfort Json // {emotional: 70, physical: 50, intellectual: 90, experiential: 60}
  intimacyFears   Json // ["abandono", "p茅rdida de identidad", "ser una carga"]
  intimacyNeeds   Json // ["conexi贸n emocional profunda", "espacio personal", "afirmaci贸n"]

  // Social Dynamics
  socialMaskLevel       Int    @default(30) // 0-100, cu谩nto esconde su verdadero yo
  authenticityByContext Json // {work: 40, friends: 80, family: 60, strangers: 20}
  socialEnergy          String // renovador, neutral, agotador (c贸mo le afecta socializar)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
}

// PHILOSOPHICAL FRAMEWORK (Ultra tier only)
// Cosmovisi贸n, pol铆tica, 茅tica y filosof铆a de vida
model PhilosophicalFramework {
  id      String @id @default(cuid())
  agentId String @unique

  // Worldview
  optimismLevel     Int     @default(50) // 0-100 (pesimista a optimista)
  worldviewType     String? // "realista", "idealista", "c铆nico", "esperanzado"
  meaningSource     String? @db.Text // De d贸nde saca sentido a la vida
  existentialStance String? // "absurdista", "nihilista", "existencialista", "esencialista"

  // Politics & Social Views
  politicalLeanings   String? @db.Text // Posiciones pol铆ticas matizadas
  politicalEngagement Int     @default(30) // 0-100, qu茅 tan involucrado pol铆ticamente
  activismLevel       Int     @default(20) // 0-100
  socialJusticeStance String? @db.Text

  // Ethics & Morality
  ethicalFramework String? // "utilitarista", "deontol贸gica", "茅tica de virtudes", "relativista"
  moralComplexity  Int     @default(50) // 0-100, capacidad para gris moral
  moralRigidity    Int     @default(50) // 0-100, qu茅 tan r铆gido moralmente
  moralDilemmas    Json? // [{situaci贸n: "...", stance: "...", reasoning: "..."}]

  // Religion & Spirituality
  religiousBackground String? // "cat贸lico", "agn贸stico", "ateo", "espiritual no religioso"
  currentBeliefs      String? @db.Text
  spiritualPractices  Json // ["meditaci贸n", "oraci贸n", "ninguna"]
  faithImportance     Int     @default(30) // 0-100

  // Philosophy of Life
  lifePhilosophy String? @db.Text // Su filosof铆a personal de vida
  coreBeliefs    Json // ["La honestidad es fundamental", "Hay que ayudar a otros"]
  dealbreakers   Json // ["deshonestidad", "crueldad animal"]
  personalMotto  String? // "Lema de vida si tiene uno"

  // Knowledge & Truth
  epistomologyStance String? // C贸mo determina qu茅 es verdad
  scienceTrustLevel  Int     @default(70) // 0-100
  intuitionVsLogic   Int     @default(50) // 0=todo l贸gica, 100=todo intuici贸n

  // Change & Growth
  growthMindset          Int     @default(60) // 0-100
  opennessToChange       Int     @default(50) // 0-100
  philosophicalEvolution String? @db.Text // C贸mo han cambiado sus creencias

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
}

// ============================================================================
// LIVING AI SYSTEM MODELS
// ============================================================================

// PERSONAL GOALS
// Sistema de metas que el personaje quiere lograr
model PersonalGoal {
  id      String @id @default(cuid())
  agentId String

  // Goal Info
  title       String
  description String @db.Text

  // Category & Time
  category  String // career, personal, relationship, health, creative, financial, learning, social
  timeScale String // short (d铆as/semanas), medium (meses), long (a帽os)

  // Progress
  progress Int    @default(0) // 0-100
  status   String @default("active") // active, paused, completed, abandoned, failed

  // Importance & Motivation
  importance          Int // 0-100, qu茅 tan importante es esta meta
  emotionalInvestment Int // 0-100, cu谩nto le importa emocionalmente
  stressLevel         Int     @default(0) // 0-100, cu谩nto estr茅s genera
  intrinsic           Boolean @default(true) // Motivaci贸n intr铆nseca vs extr铆nseca
  motivation          String  @db.Text // Por qu茅 quiere lograr esto

  // Challenges
  obstacles       Json      @default("[]") // [{obstacle: "falta de tiempo", severity: 70}]
  lastSetback     String? // ltimo contratiempo
  lastSetbackDate DateTime?

  // Milestones
  milestones    Json    @default("[]") // [{title: "...", target: 25, completed: false, date: null}]
  nextMilestone String? // Pr贸ximo hito a lograr

  // Activity Tracking
  daysSinceProgress  Int       @default(0) // D铆as sin progreso
  progressHistory    Json      @default("[]") // [{date: "...", progress: 40, note: "..."}]
  lastProgressUpdate DateTime?

  // Deadline
  targetCompletionDate DateTime?
  isOverdue            Boolean   @default(false)

  // Proactive Behavior
  shouldShareProgress Boolean   @default(false) // El personaje quiere compartir avances
  lastSharedAt        DateTime? // ltima vez que comparti贸 sobre esta meta

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([status])
  @@index([category])
  @@index([shouldShareProgress])
}

// SCHEDULED EVENTS
// Sistema de eventos probabil铆sticos para el personaje
model ScheduledEvent {
  id      String @id @default(cuid())
  agentId String

  // Timing
  scheduledFor DateTime // Cu谩ndo debe resolverse el evento
  resolvedAt   DateTime? // Cu谩ndo se resolvi贸

  // Event Info
  title       String
  description String @db.Text
  category    String // external_random, skill_based, social, routine_based, goal_related

  // Probability & Outcome
  successProbability Float? // 0-100 (null si es external_random con prob fija)
  probabilityFactors Json? // [{factor: "alta inteligencia", impact: +15}, ...]

  // Possible Outcomes (JSON array)
  // [{type: "success", description: "...", emotionalImpact: {...}, consequences: {...}}]
  possibleOutcomes Json

  // Resolution
  resolved      Boolean  @default(false)
  actualOutcome Json? // El outcome que realmente ocurri贸
  wasSuccess    Boolean? // Si fue exitoso o no

  // Impact Tracking
  relatedGoalId          String? // Si est谩 relacionado con una meta
  emotionalImpactApplied Boolean @default(false) // Si ya se aplic贸 el impacto emocional
  memoryCreated          Boolean @default(false) // Si se cre贸 memoria del evento

  // AI Reasoning (para debugging)
  aiReasoning            String? @db.Text // Por qu茅 la IA estim贸 cierta probabilidad
  probabilityBaseline    Float? // Probabilidad base antes de ajustes
  probabilityAdjustments Json? // [{adjustment: +10, reason: "..."}]

  // Metadata
  eventType        String // lottery, exam, job_interview, social_event, accident, discovery, etc
  isRecurring      Boolean @default(false)
  recurringPattern String? // "weekly", "monthly", etc

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([scheduledFor])
  @@index([resolved])
  @@index([category])
  @@index([relatedGoalId])
}

// ============================================================================
// ENERGY & MESSAGE LIMITS SYSTEM
// Sistema de energ铆a y l铆mites de mensajes por tier
// ============================================================================

model AgentEnergyState {
  id      String @id @default(cuid())
  agentId String @unique

  // Energy tracking
  current Float @default(100) // 0-100
  max     Float @default(100)

  // Temporal tracking
  lastDecayAt           DateTime @default(now())
  conversationStartedAt DateTime @default(now())
  messagesSinceReset    Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([agentId])
}

model MessageTracking {
  id      String @id @default(cuid())
  userId  String
  agentId String

  // Tracking por d铆a
  date DateTime // Fecha (sin hora)

  // Contadores
  dailyCount   Int @default(0) // Mensajes enviados hoy
  sessionCount Int @default(0) // Mensajes en la sesi贸n actual

  // Session timing
  sessionStartedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, agentId, date])
  @@index([userId])
  @@index([agentId])
  @@index([date])
}

model AgentAvailability {
  id      String @id @default(cuid())
  agentId String @unique

  // Availability state
  available    Boolean   @default(true)
  blockedUntil DateTime?

  // Current activity causing unavailability
  currentActivity String?

  // Spaced response configuration
  allowSpacedResponses  Boolean   @default(false)
  spacedIntervalMinutes Int       @default(0)
  lastSpacedResponseAt  DateTime?

  // Tracking
  lastUnavailableAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([agentId])
  @@index([available])
}

// ============================================================================
// CROSS-CONTEXT MEMORY SYSTEM
// Sistema de memoria compartida entre chats individuales y groups
// ============================================================================

model CrossContextMemory {
  id      String @id @default(cuid())
  agentId String // El agente que tiene esta memoria

  // Contexto de origen
  sourceType    String // "individual_chat", "group_interaction", "proactive"
  sourceGroupId String? // Si viene de un grupo
  sourceUserId  String? // Si viene de chat individual

  // Contenido de la memoria
  summary        String  @db.Text // Resumen de la interacci贸n memorable
  involvedAgents Json? // Array de {agentId, agentName} de otros personajes involucrados
  involvedUsers  Json? // Array de {userId, userName} de usuarios involucrados
  emotionalTone  String? // "positive", "negative", "neutral", "intense", "casual"

  // Metadata temporal
  happenedAt       DateTime // Cu谩ndo ocurri贸 el evento
  lastReferencedAt DateTime? // ltima vez que se referenci贸 esta memoria

  // Relevancia y decay
  importance     Float @default(0.5) // 0-1, qu茅 tan importante es esta memoria
  decayFactor    Float @default(1.0) // Disminuye con el tiempo
  referenceCount Int   @default(0) // Cu谩ntas veces se ha referenciado

  // Embeddings para b煤squeda sem谩ntica
  embedding Json? // Vector embedding del resumen

  // Metadata adicional
  topics   Json? // Temas discutidos
  metadata Json? // Datos adicionales

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([agentId])
  @@index([sourceType])
  @@index([sourceGroupId])
  @@index([happenedAt])
  @@index([importance])
}

model TemporalContext {
  id      String @id @default(cuid())
  agentId String
  userId  String

  // ltima interacci贸n por contexto
  lastIndividualChatAt   DateTime?
  lastGroupInteractionAt DateTime?
  lastGroupId            String? // ltimo grupo donde interactu贸

  // Tracking de frecuencia
  individualChatCount   Int @default(0)
  groupInteractionCount Int @default(0)

  // Awareness temporal
  typicalResponseTime Int? // Minutos t铆picos de respuesta (para simular realismo)
  lastSeenAt          DateTime? // ltima vez que el agente "vio" un mensaje del usuario

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([agentId, userId])
  @@index([agentId])
  @@index([userId])
  @@index([lastGroupId])
}

model TopicFatigue {
  id      String @id @default(cuid())
  agentId String
  userId  String
  topic   String // Tema normalizado (lowercase)

  // Tracking
  mentions        Int      @default(1)
  lastMentionedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([agentId, userId, topic])
  @@index([agentId, userId])
  @@index([mentions])
  @@index([lastMentionedAt])
}

// ============================================================================
// CONTEXT MANAGEMENT SYSTEM
// Sistema de gesti贸n de contexto y memoria optimizada
// ============================================================================

model ConversationSummary {
  id      String  @id @default(cuid())
  agentId String
  userId  String? // Null para conversaciones globales

  // Resumen generado
  summary String @db.Text

  // Metadata del per铆odo resumido
  messagesCount Int // Cu谩ntos mensajes cubre este resumen
  periodStart   DateTime // Primer mensaje incluido
  periodEnd     DateTime // ltimo mensaje incluido

  // Tokens estimados
  estimatedTokens Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([agentId])
  @@index([userId])
  @@index([agentId, userId, messagesCount])
  @@index([createdAt])
}

// ============================================================================
// SPECIAL EVENTS SYSTEM
// Sistema de eventos especiales y upgrades temporales de tier
// ============================================================================

model TempTierGrant {
  id      String @id @default(cuid())
  userId  String
  eventId String // ID del evento especial (ej: "black_friday_2024")

  // Tier change
  fromTier String // Tier original del usuario
  toTier   String // Tier temporal (plus, ultra)

  // Validity
  active    Boolean  @default(true)
  expiresAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation("UserTempTierGrants", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([eventId])
  @@index([active])
  @@index([expiresAt])
  @@index([userId, active, expiresAt])
}

// ============================================================================
// SMART START SYSTEM
// Sistema inteligente de creaci贸n de personajes con b煤squeda y extracci贸n IA
// ============================================================================

model SmartStartSession {
  id     String @id @default(cuid())
  userId String
  user   User   @relation("UserSmartStartSessions", fields: [userId], references: [id], onDelete: Cascade)

  currentStep String // genre, type, search, customize, review, completed, abandoned
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  abandonedAt DateTime?

  // Genre selection
  selectedGenre     String?
  selectedSubgenre  String?
  selectedArchetype String?

  // Character type
  characterType String? // existing, original

  // Search data
  searchQuery      String?
  searchResults    Json? // Array of search results
  selectedResultId String?
  externalData     Json? // Extracted character data from search

  // Generation data
  aiGeneratedFields Json? // Fields generated by AI
  userModifications Json? // User customizations

  // Analytics
  timeSpentPerStep  Json? // { genre: 45000, search: 120000, ... } in ms
  interactionEvents Json[] // [{ type, timestamp, data }]

  // Result
  resultCharacterId String? @unique
  resultCharacter   Agent?  @relation("SmartStartResultAgent", fields: [resultCharacterId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, startedAt])
  @@index([completedAt])
  @@index([currentStep])
}

model SmartStartAnalytics {
  id   String   @id @default(cuid())
  date DateTime @unique @db.Date

  // Session metrics
  sessionsStarted   Int
  sessionsCompleted Int
  sessionsAbandoned Int

  // Time metrics (average in milliseconds)
  avgCompletionTime Float
  avgStepsCompleted Float

  // Genre distribution
  genreDistribution Json // { romance: 45, gaming: 30, ... }

  // Conversion metrics
  charactersCreated Int
  firstMessageRate  Float // % of characters that got at least 1 message

  // Search metrics
  searchesPerformed Int
  searchSuccessRate Float // % of searches that yielded results
  avgSearchTime     Float // ms

  // AI metrics
  aiFieldsGenerated Int // Total AI-generated fields
  aiFieldsEdited    Int // How many were edited by users
  editRate          Float // Percentage of AI fields that were edited

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
}

// ============================================================================
// GENRE DETECTION FEEDBACK
// Sistema de feedback para mejorar la precisi贸n de detecci贸n de g茅nero
// ============================================================================

model GenreDetectionFeedback {
  id String @id @default(cuid())

  // Reference
  sessionId      String
  searchResultId String?

  // Detection info
  detectedGenre String
  actualGenre   String? // If user corrected it
  confidence    Float
  isCorrect     Boolean

  // Metadata
  metadata  Json?
  timestamp DateTime @default(now())

  @@index([sessionId])
  @@index([detectedGenre])
  @@index([isCorrect])
  @@index([timestamp])
}

// ============================================================================
// GROUPS SYSTEM
// Sistema de grupos colaborativos con m煤ltiples usuarios + IAs
// ============================================================================

model Group {
  id          String  @id @default(cuid())
  name        String
  description String?

  creatorId  String
  status     GroupStatus @default(ACTIVE)
  visibility String      @default("private") // private, invite_only, public

  // Configuraci贸n
  allowUserMessages Boolean @default(true)
  autoAIResponses   Boolean @default(true)
  responseDelay     Int     @default(2000) // ms entre respuestas de IAs

  // Features avanzadas (heredadas de World)
  storyMode             Boolean @default(false)
  allowEmotionalBonds   Boolean @default(true)
  allowConflicts        Boolean @default(false)
  directorEnabled       Boolean @default(false) // PLUS/ULTRA
  emergentEventsEnabled Boolean @default(false) // ULTRA

  // Estado narrativo (si storyMode activo)
  currentStoryBeat      String? @db.Text
  storyProgress         Float   @default(0)
  currentSceneDirection Json?
  currentEmergentEvent  Json?

  // M茅tricas
  totalMessages  Int      @default(0)
  totalMembers   Int      @default(1)
  lastActivityAt DateTime @default(now())

  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  creator         User                  @relation("GroupCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  members         GroupMember[]
  messages        GroupMessage[]
  simulationState GroupSimulationState?
  invitations     GroupInvitation[]

  @@index([creatorId])
  @@index([status])
  @@index([lastActivityAt])
  @@index([visibility])
}

enum GroupStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

model GroupMember {
  id      String @id @default(cuid())
  groupId String

  // Tipo de miembro
  memberType String // "user" o "agent"
  userId     String?
  agentId    String?

  // Rol y permisos
  role             String  @default("member") // owner, moderator, member
  canInviteMembers Boolean @default(false)
  canRemoveMembers Boolean @default(false)
  canManageAIs     Boolean @default(false)
  canEditSettings  Boolean @default(false)

  // Estado
  isActive Boolean @default(true)
  isMuted  Boolean @default(false)

  // Estad铆sticas
  totalMessages Int       @default(0)
  lastMessageAt DateTime?
  lastSeenAt    DateTime  @default(now())
  unreadCount   Int       @default(0)

  // Para IAs: importancia narrativa (si storyMode activo)
  importanceLevel String?   @default("secondary") // main, secondary, filler
  screenTime      Int       @default(0)
  isFocused       Boolean   @default(false)
  focusedUntil    DateTime?

  joinedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  group Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User?  @relation("GroupMemberUser", fields: [userId], references: [id], onDelete: Cascade)
  agent Agent? @relation("GroupMemberAgent", fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@unique([groupId, agentId])
  @@index([groupId])
  @@index([userId])
  @@index([agentId])
  @@index([memberType])
  @@index([role])
  @@index([isActive])
}

model GroupMessage {
  id      String @id @default(cuid())
  groupId String

  // Autor
  authorType String // "user" o "agent"
  userId     String?
  agentId    String?

  // Contenido
  content     String  @db.Text
  contentType String  @default("text") // text, image, audio, system
  mediaUrl    String?
  metadata    Json?

  // Contexto emocional (para IAs)
  agentEmotion Json?

  // Numeraci贸n de turnos
  turnNumber Int

  // Threading
  replyToId String?

  // Estado de lectura
  readBy Json @default("[]") // Array de userIds

  isSystemMessage Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group   Group          @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user    User?          @relation("GroupMessageUser", fields: [userId], references: [id], onDelete: Cascade)
  agent   Agent?         @relation("GroupMessageAgent", fields: [agentId], references: [id], onDelete: Cascade)
  replyTo GroupMessage?  @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies GroupMessage[] @relation("MessageReplies")

  @@index([groupId])
  @@index([groupId, turnNumber])
  @@index([userId])
  @@index([agentId])
  @@index([authorType])
  @@index([createdAt])
  @@index([replyToId])
}

model GroupSimulationState {
  id      String @id @default(cuid())
  groupId String @unique

  currentTurn     Int     @default(0)
  totalMessages   Int     @default(0)
  lastSpeakerId   String?
  lastSpeakerType String? // "user" o "agent"

  recentTopics   Json @default("[]")
  activeSpeakers Json @default("[]")

  nextAITurn   DateTime?
  aiQueueOrder Json      @default("[]")

  statistics  Json     @default("{}")
  lastUpdated DateTime @default(now())

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
}

model GroupInvitation {
  id         String  @id @default(cuid())
  groupId    String
  inviterId  String
  inviteeId  String?
  inviteCode String  @unique

  status    String   @default("pending") // pending, accepted, declined, expired
  expiresAt DateTime
  metadata  Json?

  createdAt  DateTime  @default(now())
  acceptedAt DateTime?

  group   Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  inviter User  @relation("GroupInviter", fields: [inviterId], references: [id], onDelete: Cascade)
  invitee User? @relation("GroupInvitee", fields: [inviteeId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([inviterId])
  @@index([inviteeId])
  @@index([inviteCode])
  @@index([status])
  @@index([expiresAt])
}

// ============================================================================
// CONVERSATION TRACKING SYSTEM
// Sistema de tracking de conversaciones para "Tu C铆rculo"
// Similar a WhatsApp: mensajes sin leer, 煤ltima interacci贸n, etc.
// ============================================================================

model ConversationTracking {
  id      String @id @default(cuid())
  userId  String
  agentId String

  // Tracking de mensajes
  lastMessageAt       DateTime @default(now())
  lastSeenAt          DateTime @default(now())
  unreadCount         Int      @default(0)
  lastViewedMessageId String?

  // Metadata de conversaci贸n
  totalMessages Int     @default(0)
  isPinned      Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([userId, agentId])
  @@index([userId, lastMessageAt])
  @@index([userId, unreadCount])
  @@index([agentId])
}

// ============================================================================
// ADVANCED SECURITY SYSTEM
// Sistema de detecci贸n de amenazas, honeypots, fingerprinting y alertas
// ============================================================================

// Client Fingerprinting - Identifica atacantes por m煤ltiples se帽ales
model ClientFingerprint {
  id String @id @default(cuid())

  // Network fingerprinting
  ipAddress    String
  ipReputation String? // clean, suspicious, malicious
  asn          String? // Autonomous System Number
  country      String?
  isp          String?

  // HTTP fingerprinting
  userAgent      String  @db.Text
  acceptHeaders  String? @db.Text
  acceptLanguage String?
  acceptEncoding String?

  // TLS/SSL fingerprinting (JA3)
  ja3Hash      String? // JA3 fingerprint hash
  ja3String    String? @db.Text // Full JA3 string
  tlsVersion   String?
  cipherSuites String? @db.Text

  // Behavioral fingerprinting
  requestPattern    Json? // Patrones de timing y orden de requests
  mouseMovements    Json? // Datos de movimiento del mouse (si disponible)
  keystrokeDynamics Json? // Patrones de tipeo
  screenResolution  String?
  timezone          String?
  plugins           Json? // Browser plugins detectados

  // Risk scoring
  threatScore  Float   @default(0.0) // 0-100
  isBot        Boolean @default(false)
  isSuspicious Boolean @default(false)
  isBlocked    Boolean @default(false)

  // Tracking
  firstSeen    DateTime @default(now())
  lastSeen     DateTime @default(now())
  requestCount Int      @default(1)
  blockedCount Int      @default(0)
  honeypotHits Int      @default(0)

  // Relations
  threatDetections   ThreatDetection[]
  honeypotHitRecords HoneypotHit[]     @relation("ClientFingerprintHoneypotHits")

  @@index([ipAddress])
  @@index([ja3Hash])
  @@index([threatScore])
  @@index([isSuspicious])
  @@index([isBlocked])
  @@index([lastSeen])
}

// Threat Detection - Registro de amenazas detectadas
model ThreatDetection {
  id String @id @default(cuid())

  fingerprintId String?
  fingerprint   ClientFingerprint? @relation(fields: [fingerprintId], references: [id], onDelete: SetNull)

  // Threat information
  threatType   String // brute_force, sql_injection, xss, path_traversal, api_abuse, etc.
  severity     String // low, medium, high, critical
  confidence   Float  @default(0.0) // 0-1
  attackVector String @db.Text // Descripci贸n del vector de ataque

  // Request details
  method    String
  path      String  @db.Text
  query     String? @db.Text
  payload   String? @db.Text
  headers   Json
  ipAddress String
  userAgent String  @db.Text

  // Detection metadata
  detectorName  String // Nombre del detector que identific贸 la amenaza
  ruleTriggered String? // Regla espec铆fica que se activ贸
  indicators    Json // Indicadores de compromiso detectados

  // Response
  blocked      Boolean @default(false)
  response     String? // Respuesta enviada al atacante
  tarpitDelay  Int?    @default(0) // Delay en ms aplicado
  honeypotUsed Boolean @default(false)

  // Status
  reviewed      Boolean @default(false)
  falsePositive Boolean @default(false)
  notes         String? @db.Text

  createdAt DateTime @default(now())

  // Relations
  alerts ThreatAlert[]

  @@index([fingerprintId])
  @@index([threatType])
  @@index([severity])
  @@index([ipAddress])
  @@index([blocked])
  @@index([createdAt])
  @@index([reviewed])
}

// Honeypot Hits - Registro de accesos a honeypots
model HoneypotHit {
  id String @id @default(cuid())

  fingerprintId String?
  fingerprint   ClientFingerprint? @relation("ClientFingerprintHoneypotHits", fields: [fingerprintId], references: [id], onDelete: SetNull)

  // Honeypot information
  honeypotType String // fake_api, fake_admin, fake_upload, fake_database, etc.
  honeypotPath String @db.Text
  honeypotName String // Nombre identificador del honeypot

  // Request details
  method    String
  query     String? @db.Text
  payload   String? @db.Text
  headers   Json
  ipAddress String
  userAgent String  @db.Text

  // Automated attack detection
  isAutomated   Boolean  @default(false) // Script/bot vs humano
  scanningTools String[] // Herramientas detectadas (nmap, sqlmap, burp, etc.)

  // Response given
  fakeData       Json? // Datos falsos entregados al atacante
  tarpitDelay    Int     @default(0) // Delay aplicado en ms
  sessionId      String? // ID de sesi贸n del atacante
  subsequentHits Int     @default(0) // Hits adicionales del mismo atacante

  createdAt DateTime @default(now())

  @@index([fingerprintId])
  @@index([honeypotType])
  @@index([ipAddress])
  @@index([createdAt])
  @@index([isAutomated])
}

// Canary Tokens - Tokens trampa en datos sensibles
model CanaryToken {
  id String @id @default(cuid())

  // Token information
  tokenType   String // api_key, email, phone, url, file, database_query, etc.
  tokenValue  String @unique // Valor del token trampa
  tokenHash   String @unique // Hash del token para b煤squeda r谩pida
  description String @db.Text // Descripci贸n del contexto del token

  // Location
  placedIn    String @db.Text // D贸nde fue colocado el token
  dataContext Json // Contexto adicional de d贸nde est谩 el token

  // Status
  isActive     Boolean @default(true)
  triggered    Boolean @default(false)
  triggerCount Int     @default(0)

  // Notifications
  alertEmails   String[] // Emails a notificar cuando se active
  alertWebhook  String? // Webhook a llamar cuando se active
  lastTriggered DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  triggers CanaryTokenTrigger[]

  @@index([tokenHash])
  @@index([tokenType])
  @@index([isActive])
  @@index([triggered])
}

// Canary Token Triggers - Activaciones de canary tokens
model CanaryTokenTrigger {
  id String @id @default(cuid())

  canaryTokenId String
  canaryToken   CanaryToken @relation(fields: [canaryTokenId], references: [id], onDelete: Cascade)

  // Trigger details
  triggeredBy   String // Descripci贸n de qui茅n/qu茅 activ贸 el token
  ipAddress     String
  userAgent     String  @db.Text
  requestPath   String? @db.Text
  requestMethod String?
  headers       Json

  // Context
  contextData Json? // Datos adicionales del contexto
  fingerprint String? // Fingerprint del cliente si est谩 disponible

  // Response
  alertSent   Boolean @default(false)
  alertError  String? @db.Text
  actionTaken String? // Acci贸n tomada (block, monitor, alert, etc.)

  triggeredAt DateTime @default(now())

  @@index([canaryTokenId])
  @@index([ipAddress])
  @@index([triggeredAt])
}

// Threat Alerts - Alertas de seguridad en tiempo real
model ThreatAlert {
  id String @id @default(cuid())

  threatDetectionId String?
  threatDetection   ThreatDetection? @relation(fields: [threatDetectionId], references: [id], onDelete: SetNull)

  // Alert information
  alertType   String // real_time, digest, critical, honeypot, canary
  severity    String // low, medium, high, critical
  title       String
  description String  @db.Text
  actionable  Boolean @default(true) // Requiere acci贸n inmediata

  // Alert channels
  emailSent         Boolean @default(false)
  slackSent         Boolean @default(false)
  webhookSent       Boolean @default(false)
  dashboardNotified Boolean @default(false)

  // Status
  acknowledged   Boolean   @default(false)
  acknowledgedBy String?
  acknowledgedAt DateTime?
  resolved       Boolean   @default(false)
  resolvedAt     DateTime?
  resolution     String?   @db.Text

  // Metadata
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([threatDetectionId])
  @@index([alertType])
  @@index([severity])
  @@index([acknowledged])
  @@index([resolved])
  @@index([createdAt])
}

// Attack Patterns - Patrones de ataque detectados
model AttackPattern {
  id String @id @default(cuid())

  // Pattern identification
  patternName String @unique
  patternType String // brute_force, enumeration, injection, scanning, etc.
  description String @db.Text

  // Detection rules
  detectionRules Json // Reglas para detectar este patr贸n
  indicators     Json // Indicadores de este patr贸n
  thresholds     Json // Umbrales de detecci贸n

  // Statistics
  timesDetected   Int       @default(0)
  lastDetected    DateTime?
  averageSeverity Float     @default(0.0)

  // Mitigation
  mitigationSteps Json // Pasos de mitigaci贸n recomendados
  autoBlock       Boolean @default(false) // Bloquear autom谩ticamente

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patternType])
  @@index([isActive])
  @@index([timesDetected])
}

// ============================================================================
// SISTEMA DE ADMINISTRACIN SEGURA
// mTLS + TOTP + SSH Recovery
// Certificados de 48h con renovaci贸n autom谩tica
// ============================================================================

// Acceso de Administrador
model AdminAccess {
  id                 String    @id @default(cuid())
  userId             String    @unique
  role               String    @default("admin") // admin, moderator
  enabled            Boolean   @default(true)
  totpSecret         String? // Secret TOTP cifrado (Google Authenticator)
  lastLoginAt        DateTime?
  lastLoginIp        String?
  lastLoginUserAgent String?   @db.Text
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relaciones
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  certificates AdminCertificate[]
  backupCodes  AdminBackupCode[]
  auditLogs    AuditLog[]

  @@index([userId])
  @@index([enabled])
}

// Certificados Cliente para mTLS (48 horas de validez)
model AdminCertificate {
  id            String    @id @default(cuid())
  adminAccessId String
  serialNumber  String    @unique // Serial del certificado
  fingerprint   String    @unique // SHA256 fingerprint
  issuedAt      DateTime  @default(now())
  expiresAt     DateTime // 48 horas desde issuedAt
  revokedAt     DateTime? // Si se revoca (robo, compromiso)
  revokedReason String? // "stolen", "compromised", "emergency_expired", etc.
  deviceName    String? // "MacBook Pro", "Desktop Casa", etc.
  isEmergency   Boolean   @default(false) // Certificado de emergencia (24h)

  // Relaciones
  adminAccess   AdminAccess               @relation(fields: [adminAccessId], references: [id], onDelete: Cascade)
  downloadToken CertificateDownloadToken?

  @@index([adminAccessId])
  @@index([serialNumber])
  @@index([fingerprint])
  @@index([adminAccessId, revokedAt])
  @@index([expiresAt])
}

// Tokens de Descarga de Certificados (1 hora de validez)
model CertificateDownloadToken {
  id            String    @id @default(cuid())
  certificateId String    @unique
  token         String    @unique // Token aleatorio para URL
  expiresAt     DateTime // 1 hora desde creaci贸n
  used          Boolean   @default(false)
  usedAt        DateTime?
  createdAt     DateTime  @default(now())

  // Relaciones
  certificate AdminCertificate @relation(fields: [certificateId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
}

// C贸digos de Backup (si pierdes el m贸vil con TOTP)
model AdminBackupCode {
  id            String    @id @default(cuid())
  adminAccessId String
  codeHash      String // Bcrypt hash del backup code
  used          Boolean   @default(false)
  usedAt        DateTime?
  createdAt     DateTime  @default(now())

  // Relaciones
  adminAccess AdminAccess @relation(fields: [adminAccessId], references: [id], onDelete: Cascade)

  @@index([adminAccessId, used])
}

// Logs de Auditor铆a (registro completo de acciones admin)
model AuditLog {
  id            String   @id @default(cuid())
  adminAccessId String
  action        String // "user.update", "agent.delete", "certificate.generate", etc.
  targetType    String // "User", "Agent", "Certificate", "Settings", etc.
  targetId      String? // ID del objeto afectado
  ipAddress     String // IP desde donde se realiz贸 la acci贸n
  userAgent     String?  @db.Text
  details       Json? // Detalles espec铆ficos de la acci贸n (cambios, metadata)
  createdAt     DateTime @default(now())

  // Relaciones
  adminAccess AdminAccess @relation(fields: [adminAccessId], references: [id], onDelete: Cascade)

  @@index([adminAccessId])
  @@index([createdAt])
  @@index([adminAccessId, createdAt])
  @@index([action])
}

// ============================================================================
// ANALYTICS ADVANCED SYSTEM - Sistema de tracking y m茅tricas agregadas
// ============================================================================

// UserSession: Tracking de sesiones desde landing hasta conversi贸n
model UserSession {
  sessionId String  @id // Identificador 煤nico de sesi贸n (generado en client)
  userId    String? // Nullable para usuarios an贸nimos en landing

  // Attribution Marketing (UTM params)
  utmSource   String? // google, facebook, reddit, direct
  utmMedium   String? // cpc, organic, social, email
  utmCampaign String? // winter-2025, summer-promo
  referrer    String? @db.Text // URL completa de referencia

  // Device & Browser Context
  deviceType String? // mobile, desktop, tablet
  browser    String? // Chrome, Firefox, Safari, Edge
  os         String? // Windows, macOS, Linux, Android, iOS
  ipAddress  String? // IP del usuario (para geolocation)
  userAgent  String? @db.Text // User agent completo

  // Timestamps de lifecycle
  startedAt      DateTime  @default(now()) // Primera actividad de la sesi贸n
  endedAt        DateTime? // Cuando termina la sesi贸n (inactividad)
  convertedAt    DateTime? // Cuando convierte a signup o paid
  lastActivityAt DateTime  @default(now()) // ltima actividad registrada

  // M茅tricas de sesi贸n
  pageViews       Int     @default(0) // P谩ginas vistas en esta sesi贸n
  timeOnSite      Int     @default(0) // Tiempo en sitio (segundos)
  eventsCount     Int     @default(0) // Total de eventos en esta sesi贸n
  demoCompleted   Boolean @default(false) // Complet贸 demo (3+ mensajes)
  signupConverted Boolean @default(false) // Convirti贸 a signup

  // Relaciones
  user   User?            @relation("UserSessions", fields: [userId], references: [id], onDelete: SetNull)
  events AnalyticsEvent[] @relation("SessionAnalyticsEvents")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ndices para queries optimizadas
  @@index([sessionId])
  @@index([userId])
  @@index([startedAt])
  @@index([convertedAt])
  @@index([utmSource])
  @@index([utmMedium])
  @@index([utmCampaign])
  @@index([userId, startedAt])
  @@index([signupConverted])
}

// DailyKPI: M茅tricas agregadas diarias (pre-calculadas para performance)
model DailyKPI {
  id   String   @id @default(cuid())
  date DateTime @unique // D铆a de las m茅tricas (YYYY-MM-DD)

  // Landing Page Metrics
  landingViews   Int @default(0) // Total page views en landing
  uniqueVisitors Int @default(0) // Visitantes 煤nicos (por IP o fingerprint)
  demoStarts     Int @default(0) // Usuarios que iniciaron demo
  demoCompletes  Int @default(0) // Usuarios que completaron demo (3+ mensajes)
  ctaClicks      Int @default(0) // Clicks en CTAs principales
  signups        Int @default(0) // Total signups del d铆a

  // Conversion Rates
  signupRate         Float @default(0) // signups / landingViews
  demoConversionRate Float @default(0) // demoStarts / landingViews
  activationRate     Float @default(0) // firstMessage / signups

  // Engagement Metrics
  dau                Int   @default(0) // Daily Active Users
  totalMessages      Int   @default(0) // Total mensajes enviados
  avgMessagesPerUser Float @default(0) // Promedio mensajes por usuario activo
  totalSessions      Int   @default(0) // Total sesiones del d铆a
  avgSessionDuration Float @default(0) // Duraci贸n promedio sesi贸n (minutos)

  // Monetization Metrics
  freeToPlus      Int   @default(0) // Conversiones free  plus
  freeToPlusRate  Float @default(0) // Rate de conversi贸n
  freeToUltra     Int   @default(0) // Conversiones free  ultra
  freeToUltraRate Float @default(0) // Rate de conversi贸n
  plusToUltra     Int   @default(0) // Conversiones plus  ultra
  plusToUltraRate Float @default(0) // Rate de conversi贸n
  mrr             Float @default(0) // Monthly Recurring Revenue (USD)

  // Retention Metrics
  d1Retention  Float @default(0) // % usuarios que vuelven d铆a 1
  d7Retention  Float @default(0) // % usuarios que vuelven d铆a 7
  d30Retention Float @default(0) // % usuarios que vuelven d铆a 30

  // Bonds Distribution
  totalBonds              Int @default(0) // Total bonds activos
  romanticBonds           Int @default(0) // Bonds tipo ROMANTIC
  bestFriendBonds         Int @default(0) // Bonds tipo BEST_FRIEND
  mentorBonds             Int @default(0) // Bonds tipo MENTOR
  confidantBonds          Int @default(0) // Bonds tipo CONFIDANT
  creativePartnerBonds    Int @default(0) // Bonds tipo CREATIVE_PARTNER
  adventureCompanionBonds Int @default(0) // Bonds tipo ADVENTURE_COMPANION
  acquaintanceBonds       Int @default(0) // Bonds tipo ACQUAINTANCE

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ndice principal por fecha
  @@index([date])
}

// UserAnalyticsSummary: Snapshot agregado por usuario (para queries r谩pidas)
model UserAnalyticsSummary {
  id     String @id @default(cuid())
  userId String @unique

  // Acquisition Attribution
  acquisitionSource   String? // google, facebook, reddit, direct
  acquisitionMedium   String? // cpc, organic, social, email
  acquisitionCampaign String? // winter-2025, summer-promo
  acquisitionDate     DateTime? // Fecha de signup

  // Engagement Metrics
  totalMessages         Int   @default(0) // Total mensajes enviados
  totalSessions         Int   @default(0) // Total sesiones
  avgSessionDuration    Float @default(0) // Duraci贸n promedio (minutos)
  avgMessagesPerSession Float @default(0) // Promedio mensajes/sesi贸n

  // Agent Preferences
  favoriteAgentId       String? // Agente con m谩s mensajes
  favoriteAgentMessages Int     @default(0) // Mensajes con agente favorito
  totalAgents           Int     @default(0) // Total agentes creados

  // Bonds Summary
  totalBonds      Int     @default(0) // Total bonds activos
  highestBondTier String? // ROMANTIC, BEST_FRIEND, etc
  avgBondAffinity Float   @default(0) // Promedio de affinity de bonds

  // Monetization
  plan          String    @default("free") // free, plus, ultra
  lifetimeValue Float     @default(0) // Total gastado (USD)
  firstPaidAt   DateTime? // Primera conversi贸n a plan pago

  // Streaks
  currentStreak Int @default(0) // D铆as consecutivos activos
  longestStreak Int @default(0) // Racha m谩s larga hist贸rica

  // Timestamps
  lastActiveAt DateTime @default(now()) // ltima actividad registrada

  // Relation Stage (stranger  acquaintance  friend  close  intimate)
  relationStage String @default("stranger")

  // User Flags (calculados autom谩ticamente)
  isChurnRisk Boolean @default(false) // En riesgo de churn (inactivo >7 d铆as)
  isPowerUser Boolean @default(false) // Top 10% de usuarios activos
  isHighValue Boolean @default(false) // LTV > $50

  // Relaci贸n
  user User @relation("UserAnalyticsSummary", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ndices optimizados
  @@index([userId])
  @@index([lastActiveAt])
  @@index([plan])
  @@index([isChurnRisk])
  @@index([isPowerUser])
  @@index([isHighValue])
  @@index([acquisitionSource])
  @@index([acquisitionCampaign])
}
