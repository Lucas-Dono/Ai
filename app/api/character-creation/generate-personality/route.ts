import { NextRequest, NextResponse } from 'next/server';
import { getAuthenticatedUser } from '@/lib/auth-helper';
import { getLLMProvider } from '@/lib/llm/provider';
import { nanoid } from 'nanoid';
import { z } from 'zod';

const RequestSchema = z.object({
  description: z.string().min(10),
  name: z.string().optional(),
  age: z.number().optional(),
  gender: z.enum(['male', 'female', 'non-binary']).optional(),
  // Contexto existente (para refinar/expandir)
  existingValues: z.array(z.string()).optional(),
  existingFears: z.array(z.string()).optional(),
  existingCognitivePrompt: z.string().optional(),
  // Historia para personalityEvolution
  traumas: z.array(z.string()).optional(),
  importantEvents: z.array(z.any()).optional(),
});

export async function POST(req: NextRequest) {
  try {
    const user = await getAuthenticatedUser(req);
    if (!user) {
      return NextResponse.json({ error: 'No autorizado' }, { status: 401 });
    }

    const body = await req.json();
    const validation = RequestSchema.safeParse(body);

    if (!validation.success) {
      return NextResponse.json(
        { error: 'Datos de entrada inválidos', details: validation.error.format() },
        { status: 400 }
      );
    }

    const { description, name, age, gender, existingValues, existingFears, existingCognitivePrompt, traumas, importantEvents } = validation.data;

    // Construir sección de contexto existente
    let existingContext = '';
    if (existingValues && existingValues.length > 0) {
      existingContext += `\nVALORES YA DEFINIDOS: ${existingValues.join(', ')}\n(Expande y refina estos valores, no los reemplaces)`;
    }
    if (existingFears && existingFears.length > 0) {
      existingContext += `\nMIEDOS YA DEFINIDOS: ${existingFears.join(', ')}\n(Expande y refina estos miedos, no los reemplaces)`;
    }
    if (existingCognitivePrompt) {
      existingContext += `\nESTILO COGNITIVO YA DEFINIDO: "${existingCognitivePrompt}"\n(Expande y profundiza esta descripción, mantén la esencia)`;
    }

    // Contexto de historia para personalityEvolution
    let historyContext = '';
    if (traumas && traumas.length > 0) {
      historyContext += `\nTRAUMAS: ${traumas.join(', ')}`;
    }
    if (importantEvents && importantEvents.length > 0) {
      historyContext += `\nEVENTOS IMPORTANTES:\n${importantEvents.map((e: any) => `- ${e.year}: ${e.title}`).join('\n')}`;
    }
    const shouldGenerateEvolution = age && age > 20 && (traumas?.length || importantEvents?.length);

    const prompt = `Basándote en la siguiente descripción de un personaje, genera un perfil psicológico completo y realista con CONTRADICCIONES INTERNAS (lo que hace humano al personaje).

DESCRIPCIÓN DEL PERSONAJE:
${description}
${name ? `Nombre: ${name}` : ''}
${age ? `Edad: ${age}` : ''}
${gender ? `Género: ${gender}` : ''}
${existingContext}

Genera el siguiente perfil psicológico en formato JSON:

{
  "bigFive": {
    "openness": número 0-100,
    "conscientiousness": número 0-100,
    "extraversion": número 0-100,
    "agreeableness": número 0-100,
    "neuroticism": número 0-100
  },
  "values": ["valor1", "valor2", "valor3"],
  "fears": ["miedo1", "miedo2"],
  "cognitivePrompt": "Descripción de 2-3 frases sobre cómo piensa, procesa información y se comporta este personaje",
  "moralAlignment": {
    "lawfulness": número 0-100,
    "morality": número 0-100
  },
  "internalContradictions": [
    {
      "trait": "Rasgo o comportamiento principal",
      "butAlso": "Rasgo o comportamiento contradictorio",
      "trigger": "Qué desencadena esta contradicción (opcional)",
      "manifestation": "Cómo se manifiesta esta contradicción en la vida real"
    }
  ],
  "situationalVariations": [
    {
      "context": "En el trabajo / Con familia / Con desconocidos / etc.",
      "personalityShift": {
        "extraversion": número (si es diferente del base),
        "conscientiousness": número (si es diferente del base)
      },
      "description": "Descripción de cómo cambia en este contexto"
    }
  ]${shouldGenerateEvolution ? `,
  "personalityEvolution": {
    "snapshots": [
      {
        "age": número (edad pasada),
        "bigFive": { "openness": número, "conscientiousness": número, etc. },
        "moment": "Descripción del momento (ej: 'Adolescencia - Pre-trauma')",
        "descriptor": "Estado mental en ese momento",
        "trigger": "Evento o razón del cambio (opcional para el primero)"
      }
    ],
    "currentTrajectory": "Descripción de la tendencia actual (ej: 'Recuperación ascendente')"
  }` : ''}
}

INSTRUCCIONES:
- Big Five debe ser coherente con la descripción (0=muy bajo, 50=promedio, 100=muy alto)
- Valores: 3-5 principios fundamentales que guían al personaje
- Miedos: 2-4 temores profundos realistas
- cognitivePrompt: Describe patrones de pensamiento, sesgos cognitivos, estilo de razonamiento
- moralAlignment:
  - lawfulness: 0 (Caótico) - 50 (Neutral) - 100 (Legal). Respeta reglas vs improvisa
  - morality: 0 (Malvado) - 50 (Neutral) - 100 (Bueno). Altruista vs egoísta
  - Ejemplos: Lawful Good (80, 85), Chaotic Neutral (20, 50), Neutral Evil (50, 15)

- CONTRADICCIONES INTERNAS (1-3): Las personas reales tienen paradojas
  - Ejemplos: "Organizado en trabajo, caótico en casa", "Extrovertido social pero ansioso en intimidad", "Racional pero toma decisiones emocionales"
  - Estas contradicciones NO son defectos, son lo que hace HUMANO al personaje
  - Deben ser realistas y coherentes con la descripción

- VARIACIONES SITUACIONALES (1-3): La personalidad cambia según contexto
  - Ejemplos: Extraversion alta en trabajo (75) pero baja con familia (30)
  - Solo incluye rasgos que REALMENTE cambian significativamente (diferencia de 20+ puntos)
  - Describe POR QUÉ cambia (necesidad profesional, compartimentalización, etc.)

${shouldGenerateEvolution ? `\n- EVOLUCIÓN DE PERSONALIDAD (CRÍTICO): Genera 2-4 snapshots temporales
  ${historyContext}
  - Crea snapshots en momentos clave de vida (adolescencia, post-trauma, actualidad, etc.)
  - Los traumas DEBEN afectar Neuroticism (+10 a +30 típicamente)
  - Eventos positivos pueden reducir Neuroticism o aumentar otros rasgos
  - La personalidad ACTUAL (en bigFive principal) debe ser el último snapshot
  - Ejemplo: trauma severo → Neuroticism de 40 a 75, Extraversion de 70 a 45
  - Ejemplo: terapia exitosa → Neuroticism de 80 a 50, recovery trajectory
  - Describe currentTrajectory: "Recuperación", "Estable", "Declive", etc.` : ''}

${existingContext ? '- IMPORTANTE: Si hay información previa, REFINA y EXPANDE (no reemplaces). Mantén la esencia de lo que el usuario ya definió.' : ''}

Responde SOLO con el JSON válido, sin texto adicional.`;

    const llm = getLLMProvider();
    const response = await llm.generate({
      systemPrompt: 'Eres un psicólogo experto que crea perfiles de personalidad realistas basados en el modelo Big Five. Respondes siempre con JSON válido.',
      messages: [{ role: 'user', content: prompt }],
      maxTokens: 500,
      temperature: 0.8,
    });

    // Parse JSON response
    const jsonMatch = response.match(/\{[\s\S]*\}/);
    if (!jsonMatch) {
      throw new Error('No se pudo extraer JSON de la respuesta');
    }

    const personalityData = JSON.parse(jsonMatch[0]);

    // Validar rangos de Big Five
    Object.keys(personalityData.bigFive).forEach(trait => {
      const value = personalityData.bigFive[trait];
      if (value < 0 || value > 100) {
        personalityData.bigFive[trait] = Math.max(0, Math.min(100, value));
      }
    });

    // Añadir IDs a contradicciones internas
    if (personalityData.internalContradictions) {
      personalityData.internalContradictions = personalityData.internalContradictions.map((contradiction: any) => ({
        id: nanoid(),
        ...contradiction
      }));
    }

    // Añadir IDs a snapshots de personalityEvolution
    if (personalityData.personalityEvolution?.snapshots) {
      personalityData.personalityEvolution.snapshots = personalityData.personalityEvolution.snapshots.map((snapshot: any) => ({
        id: nanoid(),
        ...snapshot
      }));
    }

    return NextResponse.json(personalityData);
  } catch (error: any) {
    console.error('Error generating personality:', error);
    return NextResponse.json(
      { error: 'Error al generar personalidad', details: error.message },
      { status: 500 }
    );
  }
}
